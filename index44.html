<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartDoc Converter | File to Database/Excel</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.0/dist/pptxgen.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add mammoth.js for docx text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
    <!-- Advanced parsing libraries -->
    <script src="https://cdn.jsdelivr.net/npm/docx-parser@1.0.0/dist/docx-parser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptx-parser@1.0.0/dist/pptx-parser.min.js"></script>
    <!-- Cloud export libraries -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
    <!-- Google Translate API is used via fetch, no script needed -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script>
      // Fix: Ensure pdfjsLib is loaded before setting workerSrc
      document.addEventListener('DOMContentLoaded', function() {
        if (window.pdfjsLib) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js';
        }
      });

      // Accessibility: Keyboard navigation for upload area
      document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
          uploadArea.setAttribute('tabindex', '0');
          uploadArea.setAttribute('role', 'button');
          uploadArea.setAttribute('aria-label', 'File upload area. Press Enter or Space to open file dialog.');
          uploadArea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              document.getElementById('fileInput').click();
            }
          });
        }
      });

      // Theme toggle logic
      document.addEventListener('DOMContentLoaded', function() {
        const themeToggle = document.getElementById('themeToggle');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let theme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
        setTheme(theme);

        themeToggle.addEventListener('click', function() {
          theme = (theme === 'dark') ? 'light' : 'dark';
          setTheme(theme);
          localStorage.setItem('theme', theme);
          // Redraw chart with correct colors for new mode
          if (convertedData) createChart(convertedData);
        });

        function setTheme(theme) {
          if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            document.body.classList.remove('light-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
          } else {
            document.body.classList.remove('dark-mode');
            document.body.classList.add('light-mode');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
          }
        }
      });
    </script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --high-contrast: #000;
            --dark-bg: #181a1b;
            --dark-card: #23272b;
        }

        /* Theme toggle button */
        .theme-toggle-btn {
            background: var(--light);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s;
        }
        .theme-toggle-btn:hover {
            background: var(--primary);
            color: #fff;
        }

        /* Light mode (default) */
        body.light-mode,
        .light-mode .upload-section,
        .light-mode .chatbot-section,
        .light-mode .results-section,
        .light-mode .file-preview {
            background-color: var(--light) !important;
            color: var(--dark) !important;
        }
        .light-mode .upload-area {
            background: #fff !important;
            border-color: var(--light-gray) !important;
        }
        .light-mode .chatbot-messages {
            background: var(--light) !important;
        }
        .light-mode th {
            background: var(--light) !important;
            color: var(--dark) !important;
        }
        .light-mode .progress-bar-container {
            background: var(--light-gray) !important;
        }
        .light-mode .progress-bar-label {
            color: var(--dark) !important;
        }
        .light-mode .table-container {
            background: var(--light) !important;
        }
        .light-mode .main-content {
            background: transparent !important;
        }
        /* Light mode gradient background */
        body.light-mode {
            background: linear-gradient(135deg, #f8f9fa 0%, #e0e7ff 100%) !important;
        }
        /* Dark mode */
        body.dark-mode {
            background-color: var(--dark-bg) !important;
            color: var(--light) !important;
            background: linear-gradient(135deg, #181a1b 0%, #23272b 100%) !important;
        }
        .dark-mode .upload-section,
        .dark-mode .chatbot-section,
        .dark-mode .results-section,
        .dark-mode .file-preview {
            background: var(--dark-card) !important;
            color: var(--light) !important;
        }
        .dark-mode .upload-area {
            background: #23272b !important;
            border-color: #343a40 !important;
        }
        .dark-mode .convert-btn,
        .dark-mode .export-btn,
        .dark-mode .signup,
        .dark-mode .login {
            color: var(--light) !important;
        }
        .dark-mode .chatbot-messages {
            background: #23272b !important;
        }
        .dark-mode th {
            background: #23272b !important;
            color: var(--light) !important;
        }
        .dark-mode .theme-toggle-btn {
            background: var(--dark-card);
            color: var(--accent);
            border-color: var(--accent);
        }
        .dark-mode .theme-toggle-btn:hover {
            background: var(--accent);
            color: #fff;
        }
        .dark-mode .progress-bar-container {
            background: #343a40 !important;
        }
        .dark-mode .progress-bar-label {
            color: #f8f9fa !important;
        }
        .dark-mode .table-container {
            background: var(--dark-card) !important;
        }
        .dark-mode .main-content {
            background: transparent !important;
        }
        /* Dark mode gradient for cards */
        .dark-mode .upload-section,
        .dark-mode .chatbot-section,
        .dark-mode .results-section {
            background: linear-gradient(135deg, #23272b 0%, #3f37c9 100%) !important;
        }
        /* Ensure all table cells adapt */
        .dark-mode table, .dark-mode th, .dark-mode td {
            background: var(--dark-card) !important;
            color: var(--light) !important;
        }
        .dark-mode tr:hover {
            background: rgba(72, 149, 239, 0.10) !important;
        }
        /* Accessibility: High contrast for better readability */
        body, .upload-section, .chatbot-section, .results-section, .file-preview {
            color: var(--dark);
            background-color: var(--light);
        }
        .convert-btn, .export-btn, .signup, .login {
            outline: 2px solid transparent;
        }
        .convert-btn:focus, .export-btn:focus, .signup:focus, .login:focus, .upload-area:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Fix for upload-section heading and description for both themes */
        .upload-section h2,
        .upload-section p {
            color: var(--primary-dark);
        }
        body.dark-mode .upload-section h2,
        body.dark-mode .upload-section p {
            color: var(--success);
        }
        .upload-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .upload-section p {
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e0e7ff 100%);
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--light-gray);
            margin-bottom: 30px;
        }
        
        .auth-buttons {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .auth-buttons button {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .login {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            margin-right: 10px;
        }
        
        .login:hover {
            background: var(--primary);
            color: white;
        }
        
        .signup {
            background: var(--primary);
            color: white;
        }
        
        .signup:hover {
            background: var(--primary-dark);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(67, 97, 238, 0.12), 0 1.5px 4px 0 rgba(60, 60, 60, 0.04);
            transition: box-shadow 0.3s, background 0.3s, border 0.3s;
        }
        
        .upload-section:hover {
            box-shadow: 0 16px 48px 0 rgba(67, 97, 238, 0.18), 0 3px 8px 0 rgba(60, 60, 60, 0.08);
        }
        
        .upload-area {
            border: 2px dashed var(--light-gray);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(72, 149, 239, 0.05);
        }
        
        .upload-area i {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 15px;
        }
        
        .upload-area h3 {
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .upload-area p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .file-input {
            display: none;
        }
        
        .options {
            margin-top: 20px;
        }
        
        .option-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .option-label {
            font-weight: 600;
            color: var(--dark);
        }
        
        .select-wrapper {
            position: relative;
            width: 60%;
        }
        
        select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--light-gray);
            background: white;
            appearance: none;
            cursor: pointer;
        }
        
        .select-wrapper::after {
            content: '▼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            pointer-events: none;
        }
        
        .convert-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .convert-btn:hover {
            background: var(--primary-dark);
        }
        
        .chatbot-section {
            background: #fff;
            border-radius: 18px;
            padding: 36px 32px 28px 32px;
            box-shadow: 0 8px 32px 0 rgba(67, 97, 238, 0.12), 0 1.5px 4px 0 rgba(60, 60, 60, 0.04);
            border: 1.5px solid #e9ecef;
            animation: fadeInUp 0.8s cubic-bezier(0.23, 1, 0.32, 1);
            transition: box-shadow 0.3s, background 0.3s, border 0.3s;
            display: flex;
            flex-direction: column;
            height: 480px; /* Fixed height for chatbot section */
            min-height: 380px;
            max-height: 520px;
        }
        
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(40px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chatbot-header {
            background: linear-gradient(90deg, #f8f9fa 60%, #e9ecef 100%);
            border-radius: 12px;
            padding: 16px 22px;
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 1.5px 6px rgba(67, 97, 238, 0.06);
            border: 1px solid #e9ecef;
            transition: background 0.3s, border 0.3s;
        }
        
        .chatbot-header i {
            font-size: 2.2rem;
            color: #f72585;
            transition: color 0.3s, transform 0.3s;
        }
        
        .chatbot-header i:hover {
            color: #4cc9f0;
            transform: scale(1.15) rotate(-8deg);
        }
        
        .chatbot-header h3 {
            color: #212529;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 0.01em;
        }
        
        .chatbot-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            background: var(--light);
            height: 0;
            min-height: 0;
            max-height: 320px; /* Fixed or max height for messages */
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .bot-message {
            background: var(--light-gray);
            color: var(--dark);
            border-bottom-left-radius: 5px;
            margin-right: auto;
        }
        
        .user-message {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
            margin-left: auto;
        }
        
        .chatbot-input {
            display: flex;
            gap: 10px;
        }
        
        .chatbot-input input {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: 20px;
            border: 1px solid var(--light-gray);
            outline: none;
        }
        
        .chatbot-input input:focus {
            border-color: var(--accent);
        }
        
        .chatbot-input button {
            padding: 12px 20px;
            border-radius: 20px;
            border: none;
            background: var(--accent);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chatbot-input button:hover {
            background: var(--primary);
        }
        
        .results-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(67, 97, 238, 0.12), 0 1.5px 4px 0 rgba(60, 60, 60, 0.04);
            margin-bottom: 40px;
            display: none;
        }
        
        .results-section:hover {
            box-shadow: 0 16px 48px 0 rgba(67, 97, 238, 0.18), 0 3px 8px 0 rgba(60, 60, 60, 0.08);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-header h2 {
            color: var(--dark);
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        .export-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .export-excel {
            background: #1d6f42;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .export-excel::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .export-excel:hover::before {
            left: 100%;
        }
        
        .export-excel:hover {
            background: #165a36;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(29, 111, 66, 0.3);
        }
        
        .export-csv {
            background: var(--gray);
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .export-csv::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .export-csv:hover::before {
            left: 100%;
        }
        
        .export-csv:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(108, 117, 125, 0.3);
        }
        
        .export-json {
            background: #495057;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .export-json::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .export-json:hover::before {
            left: 100%;
        }
        
        .export-json:hover {
            background: #343a40;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(73, 80, 87, 0.3);
        }
        
        /* Dark mode export button enhancements */
        body.dark-mode .export-excel {
            background: #28a745;
            color: #ffffff;
            border: 1px solid #28a745;
        }
        
        body.dark-mode .export-excel:hover {
            background: #218838;
            border-color: #1e7e34;
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4);
        }
        
        body.dark-mode .export-csv {
            background: #6c757d;
            color: #ffffff;
            border: 1px solid #6c757d;
        }
        
        body.dark-mode .export-csv:hover {
            background: #5a6268;
            border-color: #545b62;
            box-shadow: 0 6px 15px rgba(108, 117, 125, 0.4);
        }
        
        body.dark-mode .export-json {
            background: #495057;
            color: #ffffff;
            border: 1px solid #495057;
        }
        
        body.dark-mode .export-json:hover {
            background: #343a40;
            border-color: #2c3136;
            box-shadow: 0 6px 15px rgba(73, 80, 87, 0.4);
        }
        
        /* Enhanced dark mode for results section */
        body.dark-mode .results-section {
            background: var(--dark-card) !important;
            border: 1px solid #343a40;
        }
        
        body.dark-mode .results-section:hover {
            box-shadow: 0 16px 48px 0 rgba(72, 149, 239, 0.25);
        }
        
        body.dark-mode .export-buttons {
            background: rgba(72, 149, 239, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(72, 149, 239, 0.2);
        }
        
        /* File download success animation */
        .download-success {
            animation: downloadPulse 0.6s ease-out;
        }
        
        @keyframes downloadPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* Enhanced file preview in dark mode */
        body.dark-mode .file-preview {
            background: #2c3034 !important;
            border: 1px solid #343a40;
            color: var(--light);
        }
        
        body.dark-mode .file-info {
            color: var(--light);
        }
        
        body.dark-mode .file-name {
            color: var(--accent);
        }
        
        body.dark-mode .remove-file {
            color: #ff6b6b;
        }
        
        body.dark-mode .remove-file:hover {
            color: #ff5252;
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 400px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }
        
        th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }
        
        tr:hover {
            background: rgba(72, 149, 239, 0.05);
        }
        
        .visualization {
            margin-top: 30px;
        }
        
        .visualization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .visualization-header h3 {
            color: var(--dark);
        }
        
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        
        .chart-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .chart-type-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--light-gray);
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chart-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .chart-type-btn:hover {
            border-color: var(--accent);
        }
        
        footer {
            text-align: center;
            padding: 20px 0;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid var(--light-gray);
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .auth-buttons {
                width: 100%;
                display: flex;
                justify-content: flex-end;
                align-items: center;
                gap: 10px;
                flex-wrap: nowrap;
            }
        }
        
        /* Loading animation */
        .loader {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .loader-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Progress bar styles */
        .progress-bar-container {
            width: 100%;
            max-width: 320px;
            margin: 0 auto 12px auto;
            background: var(--light-gray);
            border-radius: 8px;
            height: 16px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(67, 97, 238, 0.08);
            position: relative;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 8px 0 0 8px;
            transition: width 0.3s cubic-bezier(0.4,0,0.2,1);
            position: absolute;
            left: 0;
            top: 0;
        }
        .progress-bar-label {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 0;
            left: 0;
            font-size: 0.95em;
            color: var(--dark);
            line-height: 16px;
            font-weight: 600;
            z-index: 2;
        }
        body.dark-mode .progress-bar-container {
            background: #343a40;
        }
        body.dark-mode .progress-bar-label {
            color: #f8f9fa;
        }
        /* File preview */
        .file-preview {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon {
            font-size: 1.5rem;
        }
        
        .file-name {
            font-weight: 600;
        }
        
        .remove-file {
            color: var(--warning);
            cursor: pointer;
            font-size: 1.2rem;
        }

        body.dark-mode select {
            background: #23272b !important;
            color: #f8f9fa !important;
            border-color: #343a40 !important;
        }
        body.dark-mode .select-wrapper::after {
            color: #f8f9fa !important;
        }

        body.dark-mode .option-label {
            color: #f8f9fa !important;
        }

        body.dark-mode .chatbot-header h3 {
            color: #f8f9fa !important;
        }

        body.dark-mode .chatbot-section {
            background: linear-gradient(135deg, #23272b 0%, #3f37c9 100%);
            box-shadow: 0 8px 32px 0 rgba(72, 149, 239, 0.18);
        }

        body.dark-mode .chatbot-header {
            background: rgba(67, 97, 238, 0.12);
        }

        body.dark-mode .upload-area h3 {
            color: #f8f9fa !important;
        }

        /* Add fade-in animation CSS */
        .fade-in { animation: fadeInMsg 0.5s; }
        @keyframes fadeInMsg { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: none;} }

        /* Gradient background for body */
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e0e7ff 100%);
            color: var(--dark);
            line-height: 1.6;
        }
        /* Enhanced card shadows */
        .upload-section, .chatbot-section, .results-section, .file-preview {
            box-shadow: 0 8px 32px 0 rgba(67, 97, 238, 0.12), 0 1.5px 4px 0 rgba(60, 60, 60, 0.04);
            transition: box-shadow 0.3s, background 0.3s, border 0.3s;
        }
        .upload-section:hover, .chatbot-section:hover, .results-section:hover {
            box-shadow: 0 16px 48px 0 rgba(67, 97, 238, 0.18), 0 3px 8px 0 rgba(60, 60, 60, 0.08);
        }
        /* Subtle button animation */
        .convert-btn, .export-btn, .theme-toggle-btn, .login, .signup, .chart-type-btn {
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .convert-btn:active, .export-btn:active, .theme-toggle-btn:active, .login:active, .signup:active, .chart-type-btn:active {
            transform: scale(0.97);
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.12);
        }
        /* Drag-and-drop feedback animation */
        .upload-area.dragover {
            border-color: var(--accent) !important;
            background: linear-gradient(120deg, #4895ef22 0%, #4cc9f022 100%) !important;
            animation: dragPulse 0.7s infinite alternate;
        }
        @keyframes dragPulse {
            from { box-shadow: 0 0 0 0 rgba(72, 149, 239, 0.15); }
            to { box-shadow: 0 0 16px 8px rgba(72, 149, 239, 0.18); }
        }
        /* Responsive table improvements */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        table {
            min-width: 400px;
        }
        @media (max-width: 600px) {
            table, th, td {
                font-size: 0.92em;
            }
            .table-container {
                padding: 0 2px;
            }
        }
        .results-header h2 {
            color: var(--dark);
        }
        body.dark-mode .results-header h2 {
            color: var(--light) !important;
        }
        
        /* Excel Customization Panel Styles */
        .excel-customization {
            border: 1px solid var(--light-gray);
            background: var(--light) !important;
            transition: all 0.3s ease;
            animation: slideInUp 0.6s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .excel-customization:hover {
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.15);
            transform: translateY(-2px);
        }
        
        .customization-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            animation: fadeInGrid 0.8s ease-out 0.2s both;
        }
        
        @keyframes fadeInGrid {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .customization-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--light-gray);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .customization-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(67, 97, 238, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .customization-section:hover::before {
            left: 100%;
        }
        
        .customization-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(67, 97, 238, 0.12);
            border-color: var(--accent);
        }
        
        .customization-section h5 {
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 600;
            font-size: 1rem;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .customization-section:hover h5 {
            color: var(--accent);
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
            transition: all 0.3s ease;
            border-radius: 6px;
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .setting-row:hover {
            background: rgba(67, 97, 238, 0.05);
            transform: translateX(5px);
        }
        
        .setting-row label {
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        
        .setting-row:hover label {
            color: var(--primary);
            font-weight: 600;
        }
        
        .setting-row input[type="text"],
        .setting-row input[type="number"],
        .setting-row select {
            padding: 6px 10px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.85rem;
            width: 130px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .setting-row input[type="text"]:focus,
        .setting-row input[type="number"]:focus,
        .setting-row select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.1);
            outline: none;
            transform: scale(1.02);
        }
        
        .setting-row input[type="color"] {
            width: 45px;
            height: 35px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .setting-row input[type="color"]:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .setting-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            accent-color: var(--accent);
        }
        
        .setting-row input[type="checkbox"]:checked {
            transform: scale(1.1);
        }
        
        /* Advanced Settings Styles */
        .advanced-settings {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideInUp 0.6s ease-out 0.4s both;
        }
        
        .advanced-settings h5 {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .advanced-settings h5:hover {
            color: var(--accent) !important;
            transform: translateX(5px);
        }
        
        .advanced-settings h5 i {
            transition: transform 0.3s ease;
        }
        
        .advanced-settings.expanded h5 i {
            transform: rotate(180deg);
        }
        
        #advancedSettingsContent {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        #advancedSettingsContent.show {
            animation: expandContent 0.4s ease-out;
        }
        
        @keyframes expandContent {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 300px;
            }
        }
        
        /* Preset Themes Styles */
        .preset-themes {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideInUp 0.6s ease-out 0.6s both;
        }
        
        .theme-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .theme-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        
        .theme-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .theme-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .theme-btn:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        /* Dark mode support for Excel customization */
        body.dark-mode .excel-customization {
            background: var(--dark-card) !important;
            border-color: #343a40;
        }
        
        body.dark-mode .customization-section {
            background: #2c3034;
            border-color: #343a40;
        }
        
        body.dark-mode .customization-section:hover {
            border-color: var(--accent);
            box-shadow: 0 12px 30px rgba(72, 149, 239, 0.2);
        }
        
        body.dark-mode .customization-section h5 {
            color: var(--accent);
        }
        
        body.dark-mode .setting-row label {
            color: var(--light);
        }
        
        body.dark-mode .setting-row:hover {
            background: rgba(72, 149, 239, 0.1);
        }
        
        body.dark-mode .setting-row input[type="text"],
        body.dark-mode .setting-row input[type="number"],
        body.dark-mode .setting-row select {
            background: #23272b;
            color: var(--light);
            border-color: #343a40;
        }
        
        body.dark-mode .setting-row input[type="text"]:focus,
        body.dark-mode .setting-row input[type="number"]:focus,
        body.dark-mode .setting-row select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
        }
        
        body.dark-mode .advanced-settings,
        body.dark-mode .preset-themes {
            background: #2c3034 !important;
            border-color: #343a40;
        }
        
        /* Responsive design for customization panel */
        @media (max-width: 768px) {
            .customization-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .setting-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .setting-row input[type="text"],
            .setting-row input[type="number"],
            .setting-row select {
                width: 100%;
            }
            
            .theme-buttons {
                justify-content: center;
            }
            
            .theme-btn {
                flex: 1;
                min-width: 120px;
            }
        }

        /* Settings feedback animation */
        @keyframes slideInRight {
            from { 
                opacity: 0; 
                transform: translateX(100%); 
            } 
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        /* Editing Mode Styles */
        .editing-mode {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(67, 97, 238, 0.12);
            margin-bottom: 40px;
            animation: fadeInUp 0.6s ease-out;
        }
        
        .editing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .editing-header h2 {
            color: var(--primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .editing-controls {
            display: flex;
            gap: 10px;
        }
        
        .edit-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .editing-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: 600px;
        }
        
        /* Sidebar Styles */
        .editing-sidebar {
            background: var(--light);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--light-gray);
            overflow-y: auto;
            max-height: 100%;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .sidebar-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .sidebar-section h4 {
            color: var(--primary);
            margin: 0 0 15px 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .control-group select,
        .control-group input[type="number"],
        .control-group input[type="color"] {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .button-group {
            display: flex;
            gap: 5px;
        }
        
        .format-btn {
            padding: 8px 10px;
            border: 1px solid var(--light-gray);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .format-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .format-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .action-btn {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--light-gray);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Spreadsheet Styles */
        .spreadsheet-container {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .spreadsheet-header {
            background: var(--light);
            padding: 10px 15px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cell-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .cell-info span:first-child {
            font-weight: 600;
            color: var(--primary);
        }
        
        .cell-info span:last-child {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .spreadsheet-tools {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #formulaBar {
            width: 300px;
            padding: 6px 10px;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .formula-btn {
            padding: 6px 10px;
            border: 1px solid var(--light-gray);
            background: var(--primary);
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .spreadsheet-grid {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        .spreadsheet-table {
            border-collapse: collapse;
            width: 100%;
            min-width: 800px;
        }
        
        .spreadsheet-table th {
            background: var(--light);
            border: 1px solid var(--light-gray);
            padding: 8px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .spreadsheet-table td {
            border: 1px solid var(--light-gray);
            padding: 6px 8px;
            min-width: 100px;
            position: relative;
        }
        
        .spreadsheet-cell {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            padding: 0;
            margin: 0;
        }
        
        .spreadsheet-cell:focus {
            background: rgba(67, 97, 238, 0.1);
        }
        
        .cell-selected {
            background: rgba(67, 97, 238, 0.2) !important;
            border: 2px solid var(--primary) !important;
        }
        
        .cell-selected .spreadsheet-cell {
            background: transparent;
        }
        
        /* Dark mode support for editing mode */
        body.dark-mode .editing-mode {
            background: var(--dark-card);
            border-color: #343a40;
        }
        
        body.dark-mode .editing-sidebar {
            background: #2c3034;
            border-color: #343a40;
        }
        
        body.dark-mode .sidebar-section h4 {
            color: var(--accent);
        }
        
        body.dark-mode .control-group label {
            color: var(--light);
        }
        
        body.dark-mode .control-group select,
        body.dark-mode .control-group input[type="number"] {
            background: #23272b;
            color: var(--light);
            border-color: #343a40;
        }
        
        body.dark-mode .format-btn,
        body.dark-mode .action-btn {
            background: #23272b;
            color: var(--light);
            border-color: #343a40;
        }
        
        body.dark-mode .format-btn:hover,
        body.dark-mode .action-btn:hover {
            background: var(--accent);
            color: white;
        }
        
        body.dark-mode .spreadsheet-container {
            background: var(--dark-card);
            border-color: #343a40;
        }
        
        body.dark-mode .spreadsheet-header {
            background: #2c3034;
            border-color: #343a40;
        }
        
        body.dark-mode .spreadsheet-table th {
            background: #2c3034;
            border-color: #343a40;
            color: var(--accent);
        }
        
        body.dark-mode .spreadsheet-table td {
            border-color: #343a40;
        }
        
        body.dark-mode #formulaBar {
            background: #23272b;
            color: var(--light);
            border-color: #343a40;
        }
        
        /* Responsive design for editing mode */
        @media (max-width: 1200px) {
            .editing-container {
                grid-template-columns: 250px 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .editing-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .editing-sidebar {
                max-height: 300px;
            }
            
            .spreadsheet-tools {
                flex-direction: column;
                gap: 5px;
            }
            
            #formulaBar {
                width: 200px;
            }
        }
        
        /* Language Selector Styles */
        .language-selector {
            position: relative;
            margin-right: 0;
            order: 1; /* Position it before login button */
        }
        
        .language-dropdown {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid var(--primary);
            border-radius: 25px;
            padding: 8px 40px 8px 15px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 140px;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.15);
            position: relative;
        }
        
        .language-dropdown:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(67, 97, 238, 0.25);
            border-color: var(--accent);
        }
        
        .language-dropdown:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
        }
        
        .language-dropdown option {
            background: #ffffff;
            color: var(--dark);
            padding: 10px;
            font-weight: 500;
        }
        
        .language-dropdown option:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Custom dropdown arrow */
        .language-selector::after {
            content: '🌐';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 1.1rem;
            transition: transform 0.6s ease;
        }
        
        .language-selector:hover::after {
            transform: translateY(-50%) rotate(360deg);
        }
        
        /* Dark mode styles for language selector */
        .dark-mode .language-dropdown {
            background: linear-gradient(135deg, #23272b 0%, #343a40 100%);
            border-color: var(--accent);
            color: var(--light);
            box-shadow: 0 2px 8px rgba(72, 149, 239, 0.2);
        }
        
        .dark-mode .language-dropdown:hover {
            box-shadow: 0 4px 16px rgba(72, 149, 239, 0.3);
            border-color: var(--success);
        }
        
        .dark-mode .language-dropdown:focus {
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
        }
        
        .dark-mode .language-dropdown option {
            background: #23272b;
            color: var(--light);
        }
        
        .dark-mode .language-dropdown option:hover {
            background: var(--accent);
            color: white;
        }
        
        /* Responsive design for language selector */
        @media (max-width: 768px) {
            .auth-buttons {
                flex-wrap: nowrap;
                gap: 8px;
            }
            
            .language-selector {
                order: 1;
                margin-right: 0;
                margin-bottom: 0;
            }
            
            .language-dropdown {
                min-width: 120px;
                font-size: 0.85rem;
                padding: 6px 35px 6px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .auth-buttons {
                flex-direction: row;
                align-items: center;
                justify-content: flex-end;
                gap: 5px;
            }
            
            .language-selector {
                order: 1;
                width: auto;
                margin-right: 0;
                margin-bottom: 0;
            }
            
            .language-dropdown {
                width: auto;
                min-width: 100px;
                text-align: center;
                font-size: 0.8rem;
                padding: 5px 30px 5px 10px;
            }
            
            .login, .signup {
                font-size: 0.85rem;
                padding: 6px 12px;
            }
        }
        
        @media (max-width: 360px) {
            .auth-buttons {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            
            .language-selector {
                order: 1;
                width: 100%;
                margin-bottom: 5px;
            }
            
            .language-dropdown {
                width: 100%;
                min-width: auto;
            }
        }
        
        /* Animation for language change */
        .language-dropdown {
            animation: fadeInScale 0.3s ease-out;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Enhanced focus states for accessibility */
        .language-dropdown:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        /* Loading state for language change */
        .language-dropdown.loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .language-dropdown.loading::after {
            content: '⏳';
            animation: spin 1s linear infinite;
        }
        
        /* Success state for language change */
        .language-dropdown.success {
            border-color: var(--success);
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
        }
        
        .language-dropdown.success::after {
            content: '✅';
            animation: bounce 0.5s ease;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(-50%);
            }
            40% {
                transform: translateY(-60%);
            }
            60% {
                transform: translateY(-55%);
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="light-mode">
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-database"></i>
                <h1>SmartDoc Converter</h1>
            </div>
            <div class="auth-buttons">
                <div class="language-selector">
                    <select id="languageSelect" class="language-dropdown">
                        <option value="en" data-flag="🇺🇸">English</option>
                        <option value="de" data-flag="🇩🇪">Deutsch</option>
                        <option value="es" data-flag="🇪🇸">Español</option>
                        <option value="ar" data-flag="🇸🇦">العربية</option>
                    </select>
                </div>
                <script>
                    // Simple test script for language selector
                    console.log('Testing language selector...');
                    const testSelect = document.getElementById('languageSelect');
                    if (testSelect) {
                        console.log('✅ Language selector found!');
                        testSelect.addEventListener('change', function() {
                            console.log('🌍 Language changed to:', this.value);
                            alert('Language changed to: ' + this.options[this.selectedIndex].text);
                        });
                    } else {
                        console.log('❌ Language selector not found!');
                    }
                </script>
                <button class="login">Log In</button>
                <button class="signup">Sign Up</button>
                <button class="theme-toggle-btn" id="themeToggle" aria-label="Toggle dark/light mode">
                    <i class="fas fa-moon"></i> Dark Mode
                </button>
            </div>
        </header>
        
        <div class="main-content">
                    <div class="upload-section">
                        <h2>Convert Files to Database/Excel</h2>
                        <p>Upload your Word, Excel, or PowerPoint files to convert them into organized databases or Excel files.</p>
                        
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3>Drag & Drop Files Here</h3>
                            <p>or click to browse files (supports multiple files)</p>
                            <input type="file" id="fileInput" class="file-input" accept=".docx,.xlsx,.pptx,.csv,.txt,.pdf,.jpg,.jpeg,.png" multiple>
                            <div class="file-list" id="fileList" style="display: none; margin-top: 15px;">
                                <h4>Selected Files:</h4>
                                <div id="fileItems"></div>
                            </div>
                        </div>
                        
                        <div id="filePreviewContainer" style="display: none;">
                            <div class="file-preview">
                                <div class="file-info">
                                    <i class="fas fa-file-word file-icon" id="fileIcon"></i>
                                    <span class="file-name" id="fileName"></span>
                                </div>
                                <i class="fas fa-times remove-file" id="removeFile"></i>
                            </div>
                        </div>
                        
                        <div class="options">
                            <div class="option-row">
                                <span class="option-label">Output Format:</span>
                                <div class="select-wrapper">
                                    <select id="outputFormat">
                                        <option value="excel">Excel Workbook (.xlsx)</option>
                                        <option value="csv">CSV File (.csv)</option>
                                        <option value="json">JSON Database</option>
                                    </select>
                                </div>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Data Organization:</span>
                                <div class="select-wrapper">
                                    <select id="dataOrganization">
                                        <option value="auto">Auto-detect Structure</option>
                                        <option value="tables">Extract Tables Only</option>
                                        <option value="text">Extract All Text</option>
                                        <option value="mixed">Mixed Content</option>
                                    </select>
                                </div>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Naming Convention:</span>
                                <div class="select-wrapper">
                                    <select id="namingConvention">
                                        <option value="original">Keep Original Names</option>
                                        <option value="snake">snake_case</option>
                                        <option value="camel">camelCase</option>
                                        <option value="pascal">PascalCase</option>
                                    </select>
                                </div>
                            </div>
                            <div class="option-row">
                                <span class="option-label">File Processing:</span>
                                <div class="select-wrapper">
                                    <select id="fileProcessing">
                                        <option value="separate">Process Separately</option>
                                        <option value="merge">Merge All Files</option>
                                        <option value="split">Split Large Files</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Excel Customization Panel -->
                        <div class="excel-customization" id="excelCustomization" style="display: none; margin-top: 20px; padding: 15px; background: var(--light-gray); border-radius: 8px;">
                            <h4 style="margin-bottom: 15px; color: var(--primary);">🎨 Excel Customization</h4>
                            
                            <div class="customization-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <!-- Font Settings -->
                                <div class="customization-section">
                                    <h5>📝 Font Settings</h5>
                                    <div class="setting-row">
                                        <label>Header Font:</label>
                                        <select id="headerFont">
                                            <option value="Arial">Arial</option>
                                            <option value="Calibri">Calibri</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Comic Sans MS">Comic Sans MS</option>
                                        </select>
                                    </div>
                                    <div class="setting-row">
                                        <label>Header Size:</label>
                                        <input type="number" id="headerSize" value="12" min="8" max="24">
                                    </div>
                                    <div class="setting-row">
                                        <label>Header Style:</label>
                                        <select id="headerStyle">
                                            <option value="normal">Normal</option>
                                            <option value="bold">Bold</option>
                                            <option value="italic">Italic</option>
                                            <option value="bold italic">Bold Italic</option>
                                        </select>
                                    </div>
                                    <div class="setting-row">
                                        <label>Data Font:</label>
                                        <select id="dataFont">
                                            <option value="Arial">Arial</option>
                                            <option value="Calibri" selected>Calibri</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Comic Sans MS">Comic Sans MS</option>
                                        </select>
                                    </div>
                                    <div class="setting-row">
                                        <label>Data Size:</label>
                                        <input type="number" id="dataSize" value="11" min="8" max="24">
                                    </div>
                                    <div class="setting-row">
                                        <label>Data Style:</label>
                                        <select id="dataStyle">
                                            <option value="normal">Normal</option>
                                            <option value="bold">Bold</option>
                                            <option value="italic">Italic</option>
                                            <option value="bold italic">Bold Italic</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Color Settings -->
                                <div class="customization-section">
                                    <h5>🎨 Color Settings</h5>
                                    <div class="setting-row">
                                        <label>Header Background:</label>
                                        <input type="color" id="headerBgColor" value="#4361ee">
                                    </div>
                                    <div class="setting-row">
                                        <label>Header Text:</label>
                                        <input type="color" id="headerTextColor" value="#ffffff">
                                    </div>
                                    <div class="setting-row">
                                        <label>Data Text Color:</label>
                                        <input type="color" id="dataTextColor" value="#000000">
                                    </div>
                                    <div class="setting-row">
                                        <label>Alternate Row Color:</label>
                                        <input type="color" id="alternateRowColor" value="#f8f9fa">
                                    </div>
                                    <div class="setting-row">
                                        <label>Border Color:</label>
                                        <input type="color" id="borderColor" value="#e0e0e0">
                                    </div>
                                    <div class="setting-row">
                                        <label>Grid Lines:</label>
                                        <select id="gridLines">
                                            <option value="all">All Borders</option>
                                            <option value="horizontal">Horizontal Only</option>
                                            <option value="vertical">Vertical Only</option>
                                            <option value="none">No Borders</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Layout Settings -->
                                <div class="customization-section">
                                    <h5>📐 Layout Settings</h5>
                                    <div class="setting-row">
                                        <label>Auto-fit Columns:</label>
                                        <input type="checkbox" id="autoFitColumns" checked>
                                    </div>
                                    <div class="setting-row">
                                        <label>Freeze Header Row:</label>
                                        <input type="checkbox" id="freezeHeader" checked>
                                    </div>
                                    <div class="setting-row">
                                        <label>Add Filters:</label>
                                        <input type="checkbox" id="addFilters" checked>
                                    </div>
                                    <div class="setting-row">
                                        <label>Row Height:</label>
                                        <input type="number" id="rowHeight" value="20" min="15" max="50">
                                    </div>
                                    <div class="setting-row">
                                        <label>Column Width:</label>
                                        <input type="number" id="columnWidth" value="15" min="8" max="100">
                                    </div>
                                    <div class="setting-row">
                                        <label>Text Alignment:</label>
                                        <select id="textAlignment">
                                            <option value="left">Left</option>
                                            <option value="center">Center</option>
                                            <option value="right">Right</option>
                                            <option value="justify">Justify</option>
                                        </select>
                                    </div>
                                    <div class="setting-row">
                                        <label>Wrap Text:</label>
                                        <input type="checkbox" id="wrapText">
                                    </div>
                                </div>
                                
                                <!-- Sheet Settings -->
                                <div class="customization-section">
                                    <h5>📋 Sheet Settings</h5>
                                    <div class="setting-row">
                                        <label>Sheet Name:</label>
                                        <input type="text" id="sheetName" value="Data" placeholder="Sheet name">
                                    </div>
                                    <div class="setting-row">
                                        <label>Include Summary Sheet:</label>
                                        <input type="checkbox" id="includeSummary" checked>
                                    </div>
                                    <div class="setting-row">
                                        <label>Include Charts Sheet:</label>
                                        <input type="checkbox" id="includeCharts">
                                    </div>
                                    <div class="setting-row">
                                        <label>Protect Sheet:</label>
                                        <input type="checkbox" id="protectSheet">
                                    </div>
                                    <div class="setting-row">
                                        <label>Page Orientation:</label>
                                        <select id="pageOrientation">
                                            <option value="portrait">Portrait</option>
                                            <option value="landscape">Landscape</option>
                                        </select>
                                    </div>
                                    <div class="setting-row">
                                        <label>Margins (inches):</label>
                                        <input type="number" id="pageMargins" value="0.75" min="0.1" max="2" step="0.1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Settings Section -->
                            <div class="advanced-settings" style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid var(--light-gray);">
                        <h5 style="margin-bottom: 15px; color: var(--primary); cursor: pointer;" onclick="toggleAdvancedSettings()">
                            ⚙️ Advanced Settings <i class="fas fa-chevron-down" id="advancedToggle"></i>
                        </h5>
                        <div id="advancedSettingsContent" style="display: none;">
                            <div class="advanced-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="setting-row">
                                    <label>Number Format:</label>
                                    <select id="numberFormat">
                                        <option value="general">General</option>
                                        <option value="number">Number</option>
                                        <option value="currency">Currency</option>
                                        <option value="percentage">Percentage</option>
                                        <option value="date">Date</option>
                                        <option value="time">Time</option>
                                        <option value="text">Text</option>
                                    </select>
                                </div>
                                <div class="setting-row">
                                    <label>Decimal Places:</label>
                                    <input type="number" id="decimalPlaces" value="2" min="0" max="10">
                                </div>
                                <div class="setting-row">
                                    <label>Conditional Formatting:</label>
                                    <input type="checkbox" id="conditionalFormatting">
                                </div>
                                <div class="setting-row">
                                    <label>Data Validation:</label>
                                    <input type="checkbox" id="dataValidation">
                                </div>
                                <div class="setting-row">
                                    <label>Auto-calculate Totals:</label>
                                    <input type="checkbox" id="autoCalculateTotals" checked>
                                </div>
                                <div class="setting-row">
                                    <label>Include Timestamp:</label>
                                    <input type="checkbox" id="includeTimestamp" checked>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preset Themes -->
                    <div class="preset-themes" style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid var(--light-gray);">
                        <h5 style="margin-bottom: 15px; color: var(--primary);">🎨 Preset Themes</h5>
                        <div class="theme-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="theme-btn" onclick="applyTheme('professional')" style="background: #2c3e50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                                Professional
                            </button>
                            <button class="theme-btn" onclick="applyTheme('modern')" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                                Modern
                            </button>
                            <button class="theme-btn" onclick="applyTheme('elegant')" style="background: #9b59b6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                                Elegant
                            </button>
                            <button class="theme-btn" onclick="applyTheme('minimal')" style="background: #34495e; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                                Minimal
                            </button>
                            <button class="theme-btn" onclick="applyTheme('colorful')" style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                                Colorful
                            </button>
                            <button class="theme-btn" onclick="applyTheme('dark')" style="background: #2c3e50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                                Dark
                            </button>
                        </div>
                        
                        <!-- Preview Button -->
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="previewExcelSettings()" style="background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                👁️ Preview Settings
                            </button>
                            <button onclick="testExcelStyling()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; margin-left: 10px;">
                                🧪 Test Styling
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Cloud Export Options -->
                <div class="cloud-export" id="cloudExport" style="display: none; margin-top: 20px; padding: 15px; background: var(--light-gray); border-radius: 8px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary);">☁️ Cloud Export</h4>
                    <div class="cloud-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="cloud-btn" id="googleDriveBtn" style="background: #4285f4; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            <i class="fab fa-google-drive"></i> Google Drive
                        </button>
                        <button class="cloud-btn" id="dropboxBtn" style="background: #0061fe; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            <i class="fab fa-dropbox"></i> Dropbox
                        </button>
                        <button class="cloud-btn" id="onedriveBtn" style="background: #0078d4; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            <i class="fab fa-microsoft"></i> OneDrive
                        </button>
                    </div>
                </div>
                
                <button class="convert-btn" id="convertBtn">Convert Now</button>
                
                <div class="loader" id="loader">
                    <div class="progress-bar-container" aria-label="File conversion progress">
                        <div class="progress-bar" id="progressBar"></div>
                        <span class="progress-bar-label" id="progressBarLabel">0%</span>
                    </div>
                    <div class="loader-spinner"></div>
                    <p>Processing your file...</p>
                </div>
            </div>
            
            <div class="chatbot-section">
                <div class="chatbot-header">
                    <i class="fas fa-robot"></i>
                    <h3>SmartDoc Assistant</h3>
                </div>
                
                <div class="chatbot-messages" id="chatbotMessages">
                    <div class="message bot-message">
                        Hello! I'm your SmartDoc Assistant. I can help you convert files, modify your database, or answer any questions you have. How can I assist you today?
                    </div>
                </div>
                
                <div class="chatbot-input">
                    <input type="text" id="chatbotInput" placeholder="Ask me anything...">
                    <button id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>Conversion Results</h2>
                <div class="export-buttons">
                    <button class="export-btn" onclick="enterEditingMode()" style="background: #fd7e14;">
                        <i class="fas fa-edit"></i> Edit Mode
                    </button>
                    <button class="export-btn export-excel">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="export-btn" onclick="simpleExportToExcel()" style="background: #17a2b8;">
                        <i class="fas fa-file-excel"></i> Simple Export
                    </button>
                    <button class="export-btn" onclick="testExport()" style="background: #dc3545;">
                        <i class="fas fa-bug"></i> Test Export
                    </button>
                    <button class="export-btn" onclick="verifyDataProcessing()" style="background: #6f42c1;">
                        <i class="fas fa-chart-bar"></i> Verify Data
                    </button>
                    <button class="export-btn export-csv">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button class="export-btn export-json">
                        <i class="fas fa-file-code"></i> Export JSON
                    </button>
                    <button class="export-btn" id="collaborateBtn">
                        <i class="fas fa-users"></i> Collaborate
                    </button>
                    <button class="export-btn" id="exportDbBtn">
                        <i class="fas fa-database"></i> Export to Database
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div class="visualization">
                <div class="visualization-header">
                    <h3>Data Visualization</h3>
                    <div class="chart-type-selector">
                        <button class="chart-type-btn active" data-chart="bar">Bar</button>
                        <button class="chart-type-btn" data-chart="line">Line</button>
                        <button class="chart-type-btn" data-chart="pie">Pie</button>
                        <button class="chart-type-btn" data-chart="doughnut">Doughnut</button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="dataChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Editing Mode Section -->
        <div class="editing-mode" id="editingMode" style="display: none;">
            <div class="editing-header">
                <h2><i class="fas fa-edit"></i> Spreadsheet Editor</h2>
                <div class="editing-controls">
                    <button class="edit-btn" onclick="saveEdits()" style="background: #28a745;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button class="edit-btn" onclick="exitEditingMode()" style="background: #6c757d;">
                        <i class="fas fa-times"></i> Exit Editor
                    </button>
                    <button class="edit-btn" onclick="exportFromEditor()" style="background: #17a2b8;">
                        <i class="fas fa-download"></i> Export Excel
                    </button>
                </div>
            </div>
            
            <div class="editing-container">
                <!-- Sidebar with Controls -->
                <div class="editing-sidebar">
                    <div class="sidebar-section">
                        <h4><i class="fas fa-palette"></i> Formatting</h4>
                        <div class="control-group">
                            <label>Font Family:</label>
                            <select id="editFontFamily" onchange="applyCellFormat('fontFamily')">
                                <option value="Arial">Arial</option>
                                <option value="Calibri" selected>Calibri</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Verdana">Verdana</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Font Size:</label>
                            <input type="number" id="editFontSize" value="11" min="8" max="72" onchange="applyCellFormat('fontSize')">
                        </div>
                        <div class="control-group">
                            <label>Font Style:</label>
                            <div class="button-group">
                                <button class="format-btn" onclick="toggleFormat('bold')" id="boldBtn">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button class="format-btn" onclick="toggleFormat('italic')" id="italicBtn">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button class="format-btn" onclick="toggleFormat('underline')" id="underlineBtn">
                                    <i class="fas fa-underline"></i>
                                </button>
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Text Color:</label>
                            <input type="color" id="editTextColor" value="#000000" onchange="applyCellFormat('textColor')">
                        </div>
                        <div class="control-group">
                            <label>Background Color:</label>
                            <input type="color" id="editBgColor" value="#ffffff" onchange="applyCellFormat('bgColor')">
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h4><i class="fas fa-align-left"></i> Alignment</h4>
                        <div class="control-group">
                            <label>Horizontal:</label>
                            <div class="button-group">
                                <button class="format-btn" onclick="setAlignment('left')" id="alignLeftBtn">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button class="format-btn" onclick="setAlignment('center')" id="alignCenterBtn">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button class="format-btn" onclick="setAlignment('right')" id="alignRightBtn">
                                    <i class="fas fa-align-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Vertical:</label>
                            <div class="button-group">
                                <button class="format-btn" onclick="setVerticalAlignment('top')" id="valignTopBtn">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="format-btn" onclick="setVerticalAlignment('middle')" id="valignMiddleBtn">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button class="format-btn" onclick="setVerticalAlignment('bottom')" id="valignBottomBtn">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h4><i class="fas fa-border-all"></i> Borders</h4>
                        <div class="control-group">
                            <label>Border Style:</label>
                            <select id="editBorderStyle" onchange="applyBorder()">
                                <option value="none">None</option>
                                <option value="thin">Thin</option>
                                <option value="medium">Medium</option>
                                <option value="thick">Thick</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Border Color:</label>
                            <input type="color" id="editBorderColor" value="#000000" onchange="applyBorder()">
                        </div>
                        <div class="control-group">
                            <label>Border Position:</label>
                            <div class="button-group">
                                <button class="format-btn" onclick="toggleBorder('top')" id="borderTopBtn">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="format-btn" onclick="toggleBorder('bottom')" id="borderBottomBtn">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                                <button class="format-btn" onclick="toggleBorder('left')" id="borderLeftBtn">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <button class="format-btn" onclick="toggleBorder('right')" id="borderRightBtn">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h4><i class="fas fa-table"></i> Table Operations</h4>
                        <div class="control-group">
                            <button class="action-btn" onclick="addRow()">
                                <i class="fas fa-plus"></i> Add Row
                            </button>
                            <button class="action-btn" onclick="addColumn()">
                                <i class="fas fa-plus"></i> Add Column
                            </button>
                        </div>
                        <div class="control-group">
                            <button class="action-btn" onclick="deleteRow()">
                                <i class="fas fa-trash"></i> Delete Row
                            </button>
                            <button class="action-btn" onclick="deleteColumn()">
                                <i class="fas fa-trash"></i> Delete Column
                            </button>
                        </div>
                        <div class="control-group">
                            <button class="action-btn" onclick="mergeCells()">
                                <i class="fas fa-object-group"></i> Merge Cells
                            </button>
                            <button class="action-btn" onclick="splitCells()">
                                <i class="fas fa-object-ungroup"></i> Split Cells
                            </button>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h4><i class="fas fa-magic"></i> Quick Actions</h4>
                        <div class="control-group">
                            <button class="action-btn" onclick="autoFitColumns()">
                                <i class="fas fa-expand-arrows-alt"></i> Auto-fit Columns
                            </button>
                            <button class="action-btn" onclick="clearFormatting()">
                                <i class="fas fa-eraser"></i> Clear Formatting
                            </button>
                        </div>
                        <div class="control-group">
                            <button class="action-btn" onclick="selectAll()">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                            <button class="action-btn" onclick="copySelection()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="action-btn" onclick="pasteSelection()">
                                <i class="fas fa-paste"></i> Paste
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Spreadsheet Grid -->
                <div class="spreadsheet-container">
                    <div class="spreadsheet-header">
                        <div class="cell-info">
                            <span id="cellAddress">A1</span>
                            <span id="cellValue"></span>
                        </div>
                        <div class="spreadsheet-tools">
                            <input type="text" id="formulaBar" placeholder="Enter formula or value..." onkeydown="handleFormulaInput(event)">
                            <button onclick="applyFormula()" class="formula-btn">
                                <i class="fas fa-equals"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="spreadsheet-grid" id="spreadsheetGrid">
                        <!-- Grid will be generated dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>&copy; 2023 SmartDoc Converter. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // Global variables
        let currentFile = null;
        let selectedFiles = [];
        let convertedData = null;
        let chart = null;
        let batchResults = [];
        let excelSettings = {
            headerFont: 'Arial',
            headerSize: 12,
            dataFont: 'Calibri',
            dataSize: 11,
            headerBgColor: '#4361ee',
            headerTextColor: '#ffffff',
            alternateRowColor: '#f8f9fa',
            borderColor: '#e0e0e0',
            autoFitColumns: true,
            freezeHeader: true,
            addFilters: true,
            rowHeight: 20,
            sheetName: 'Data',
            includeSummary: true,
            includeCharts: false,
            protectSheet: false
        };
        
        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const filePreviewContainer = document.getElementById('filePreviewContainer');
        const fileName = document.getElementById('fileName');
        const fileIcon = document.getElementById('fileIcon');
        const removeFile = document.getElementById('removeFile');
        const convertBtn = document.getElementById('convertBtn');
        const loader = document.getElementById('loader');
        const resultsSection = document.getElementById('resultsSection');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const chatbotMessages = document.getElementById('chatbotMessages');
        const chatbotInput = document.getElementById('chatbotInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        
        // Event listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleMultipleFiles(Array.from(e.dataTransfer.files));
            }
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleMultipleFiles(Array.from(fileInput.files));
            }
        });
        
        removeFile.addEventListener('click', () => {
            selectedFiles = [];
            fileInput.value = '';
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('fileItems').innerHTML = '';
        });
        
        convertBtn.addEventListener('click', convertFile);
        sendMessageBtn.addEventListener('click', sendChatMessage);
        chatbotInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });
        
        // Chart type buttons
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                updateChart(btn.dataset.chart);
                // Redraw chart with correct colors for current mode
                if (convertedData) createChart(convertedData);
            });
        });
        
        // Export buttons
        document.querySelector('.export-excel').addEventListener('click', exportToExcel);
        document.querySelector('.export-csv').addEventListener('click', exportToCSV);
        document.querySelector('.export-json').addEventListener('click', exportToJSON);
        
        // Show/hide Excel customization based on output format
        document.getElementById('outputFormat').addEventListener('change', function() {
            const excelCustomization = document.getElementById('excelCustomization');
            const cloudExport = document.getElementById('cloudExport');
            if (this.value === 'excel') {
                excelCustomization.style.display = 'block';
                cloudExport.style.display = 'block';
            } else {
                excelCustomization.style.display = 'none';
                cloudExport.style.display = 'none';
            }
        });
        
        // Show Excel customization by default since Excel is the default output format
        document.addEventListener('DOMContentLoaded', function() {
            const excelCustomization = document.getElementById('excelCustomization');
            const cloudExport = document.getElementById('cloudExport');
            const outputFormat = document.getElementById('outputFormat');
            
            if (outputFormat.value === 'excel') {
                excelCustomization.style.display = 'block';
                cloudExport.style.display = 'block';
            }
        });
        
        // Cloud export buttons
        document.getElementById('googleDriveBtn').addEventListener('click', exportToGoogleDrive);
        document.getElementById('dropboxBtn').addEventListener('click', exportToDropbox);
        document.getElementById('onedriveBtn').addEventListener('click', exportToOneDrive);
        
        // Functions
        function handleMultipleFiles(files) {
            selectedFiles = files.filter(file => {
                const validExtensions = ['.docx', '.xlsx', '.pptx', '.csv', '.txt', '.pdf', '.jpg', '.jpeg', '.png'];
                const isValid = validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
                
                if (!isValid) {
                    addBotMessage(`⚠️ File "${file.name}" is not supported. Supported formats: DOCX, XLSX, PPTX, CSV, TXT, PDF, JPG, JPEG, PNG`);
                }
                
                return isValid;
            });
            
            if (selectedFiles.length === 0) {
                addBotMessage('❌ No valid files selected. Please choose files with supported formats.');
                return;
            }
            
            displayFileList();
            addBotMessage(`✅ ${selectedFiles.length} file(s) selected successfully!`);
        }
        
        function displayFileList() {
            const fileList = document.getElementById('fileList');
            const fileItems = document.getElementById('fileItems');
            
            fileList.style.display = 'block';
            fileItems.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.style.cssText = `
                    display: flex; align-items: center; justify-content: space-between;
                    padding: 8px 12px; margin: 5px 0; background: var(--light-gray);
                    border-radius: 6px; border-left: 4px solid var(--primary);
                `;
                
                const fileIcon = getFileIcon(file.name);
                fileItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="${fileIcon.class}" style="color: ${fileIcon.color};"></i>
                        <span style="font-weight: 600;">${file.name}</span>
                        <span style="font-size: 0.8em; color: var(--gray);">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button onclick="removeFileAtIndex(${index})" style="background: none; border: none; color: var(--warning); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                fileItems.appendChild(fileItem);
            });
        }
        
        function removeFileAtIndex(index) {
            selectedFiles.splice(index, 1);
            if (selectedFiles.length === 0) {
                document.getElementById('fileList').style.display = 'none';
            } else {
                displayFileList();
            }
        }
        
        function getFileIcon(fileName) {
            if (fileName.endsWith('.docx')) {
                return { class: 'fas fa-file-word', color: '#2b579a' };
            } else if (fileName.endsWith('.xlsx')) {
                return { class: 'fas fa-file-excel', color: '#217346' };
            } else if (fileName.endsWith('.pptx')) {
                return { class: 'fas fa-file-powerpoint', color: '#d24726' };
            } else if (fileName.endsWith('.csv')) {
                return { class: 'fas fa-file-csv', color: '#3a7d34' };
            } else if (fileName.endsWith('.txt')) {
                return { class: 'fas fa-file-alt', color: '#6c757d' };
            } else if (fileName.endsWith('.pdf')) {
                return { class: 'fas fa-file-pdf', color: '#b30b00' };
            } else if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.png')) {
                return { class: 'fas fa-file-image', color: '#888' };
            } else {
                return { class: 'fas fa-file', color: '#888' };
            }
        }
        
        async function convertFile() {
            if (selectedFiles.length === 0) {
                addBotMessage('Please select a file first.');
                return;
            }
            
            loader.style.display = 'block';
            convertBtn.disabled = true;
            
            // Progress bar simulation
            const progressBar = document.getElementById('progressBar');
            const progressBarLabel = document.getElementById('progressBarLabel');
            let progress = 0;
            progressBar.style.width = '0%';
            progressBarLabel.textContent = '0%';
            let progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 8 + 2; // random step for realism
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                    progressBarLabel.textContent = Math.floor(progress) + '%';
                }
            }, 180);
            
            try {
                // Batch processing
                if (selectedFiles.length === 1) {
                    // Single file processing
                    convertedData = await processSingleFile(selectedFiles[0]);
                } else {
                    // Multiple files processing
                    batchResults = await processMultipleFiles(selectedFiles);
                    // Merge results or show first file
                    convertedData = batchResults[0]?.data || null;
                }
                
                displayResults(convertedData);
                if (selectedFiles.length === 1) {
                    addBotMessage('✅ Your file has been successfully converted! You can now view and edit the data.');
                } else {
                    addBotMessage(`✅ Successfully processed ${selectedFiles.length} files! Showing first file. Use chatbot to switch between files.`);
                }
                
                resultsSection.style.display = 'block';
                loader.style.display = 'none';
                convertBtn.disabled = false;
                
                // Complete progress bar
                progressBar.style.width = '100%';
                progressBarLabel.textContent = '100%';
                setTimeout(() => {
                    progressBar.style.width = '0%';
                    progressBarLabel.textContent = '0%';
                    clearInterval(progressInterval);
                }, 600);
                
                // Scroll to results
                setTimeout(() => {
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                }, 300);
            } catch (error) {
                console.error('Conversion error:', error);
                addBotMessage(`❌ Error processing files: ${error.message}. Please check your files and try again.`);
                loader.style.display = 'none';
                convertBtn.disabled = false;
                progressBar.style.width = '0%';
                progressBarLabel.textContent = '0%';
                clearInterval(progressInterval);
            }
        }
        
        async function processSingleFile(file) {
            try {
                if (file.name.endsWith('.docx')) {
                    return await processDocxFile(file);
                } else if (file.name.endsWith('.xlsx')) {
                    return await processExcelFile(file);
                } else if (file.name.endsWith('.pptx')) {
                    return await processPptxFile(file);
                } else if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                    return await processTextFile(file);
                } else if (file.name.endsWith('.pdf')) {
                    return await processPdfFile(file);
                } else if (file.name.match(/\.(jpg|jpeg|png)$/i)) {
                    return await processImageFile(file);
                } else {
                    throw new Error(`Unsupported file type: ${file.name}`);
                }
            } catch (error) {
                throw new Error(`Failed to process ${file.name}: ${error.message}`);
            }
        }
        
        async function processMultipleFiles(files) {
            const results = [];
            const fileProcessing = document.getElementById('fileProcessing').value;
            
            if (fileProcessing === 'merge') {
                // Merge all files into one dataset
                const mergedData = await mergeFiles(files);
                results.push({ fileName: 'Merged Files', data: mergedData });
            } else if (fileProcessing === 'split') {
                // Split large files
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    try {
                        const splitResults = await splitFile(file);
                        splitResults.forEach((result, index) => {
                            results.push({ 
                                fileName: `${file.name}_Part${index + 1}`, 
                                data: result 
                            });
                        });
                    } catch (error) {
                        addBotMessage(`⚠️ Failed to process ${file.name}: ${error.message}`);
                    }
                }
            } else {
                // Process separately (default)
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    try {
                        const data = await processSingleFile(file);
                        results.push({ fileName: file.name, data: data });
                    } catch (error) {
                        addBotMessage(`⚠️ Failed to process ${file.name}: ${error.message}`);
                    }
                }
            }
            return results;
        }
        
        async function mergeFiles(files) {
            const allRows = [];
            const allHeaders = new Set();
            
            // First pass: collect all headers
            for (const file of files) {
                try {
                    const data = await processSingleFile(file);
                    data.headers.forEach(header => allHeaders.add(header));
                } catch (error) {
                    addBotMessage(`⚠️ Skipping ${file.name}: ${error.message}`);
                }
            }
            
            const mergedHeaders = Array.from(allHeaders);
            
            // Second pass: merge all rows
            for (const file of files) {
                try {
                    const data = await processSingleFile(file);
                    data.rows.forEach(row => {
                        const mergedRow = {};
                        mergedHeaders.forEach(header => {
                            mergedRow[header] = row[header] || '';
                        });
                        allRows.push(mergedRow);
                    });
                } catch (error) {
                    addBotMessage(`⚠️ Skipping ${file.name}: ${error.message}`);
                }
            }
            
            return {
                headers: mergedHeaders,
                rows: allRows
            };
        }
        
        async function splitFile(file) {
            const data = await processSingleFile(file);
            const results = [];
            const chunkSize = 1000; // Split into chunks of 1000 rows
            
            for (let i = 0; i < data.rows.length; i += chunkSize) {
                const chunk = data.rows.slice(i, i + chunkSize);
                results.push({
                    headers: data.headers,
                    rows: chunk
                });
            }
            
            return results;
        }
        
        async function processDocxFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        // Enhanced DOCX parsing with table detection
                        const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                        const text = result.value;
                        
                        // Try to detect tables first
                        const tableData = detectTablesInText(text);
                        if (tableData.length > 0) {
                            resolve({
                                headers: tableData[0].headers,
                                rows: tableData[0].rows
                            });
                            return;
                        }
                        
                        // Fallback to structured content extraction
                        const structuredData = extractStructuredContent(text);
                        resolve({
                            headers: structuredData.headers,
                            rows: structuredData.rows
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function detectTablesInText(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const tables = [];
            
            // Simple table detection based on consistent separators
            let currentTable = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Check if line contains table-like structure (tabs, multiple spaces, or |)
                if (line.includes('\t') || line.match(/\s{3,}/) || line.includes('|')) {
                    const cells = line.split(/\t|\s{3,}|\|/).filter(cell => cell.trim());
                    
                    if (cells.length > 1) {
                        if (!currentTable) {
                            currentTable = {
                                headers: cells.map((cell, index) => `Column ${index + 1}`),
                                rows: []
                            };
                        } else {
                            const row = {};
                            currentTable.headers.forEach((header, index) => {
                                row[header] = cells[index] || '';
                            });
                            currentTable.rows.push(row);
                        }
                    }
                } else if (currentTable && line.trim()) {
                    // End of table
                    tables.push(currentTable);
                    currentTable = null;
                }
            }
            
            if (currentTable) {
                tables.push(currentTable);
            }
            
            return tables;
        }
        
        function extractStructuredContent(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const data = [];
            const headers = ['Section', 'Content', 'Type'];
            
            let currentSection = '';
            let currentContent = '';
            
            // First pass: try to detect structured content
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                
                // Detect headers (lines with different formatting or all caps)
                if (trimmedLine.length < 100 && (trimmedLine === trimmedLine.toUpperCase() || 
                    trimmedLine.match(/^[A-Z][a-z]+(\s+[A-Z][a-z]+)*$/) ||
                    trimmedLine.match(/^\d+\.\s/) ||
                    trimmedLine.match(/^[A-Z][a-z]+:/))) {
                    if (currentSection && currentContent) {
                        data.push({
                            'Section': currentSection,
                            'Content': currentContent.trim(),
                            'Type': 'Content'
                        });
                    }
                    currentSection = trimmedLine;
                    currentContent = '';
                } else {
                    currentContent += (currentContent ? ' ' : '') + trimmedLine;
                }
            });
            
            // Add the last section
            if (currentSection || currentContent) {
                data.push({
                    'Section': currentSection || `Section ${data.length + 1}`,
                    'Content': currentContent.trim(),
                    'Type': 'Content'
                });
            }
            
            // If we have very little structured data, create a more comprehensive extraction
            if (data.length < 3) {
                const comprehensiveData = [];
                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    if (trimmedLine) {
                        comprehensiveData.push({
                            'Section': `Line ${index + 1}`,
                            'Content': trimmedLine,
                            'Type': 'Text'
                        });
                    }
                });
                return { headers, rows: comprehensiveData };
            }
            
            return { headers, rows: data };
        }
        
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        
                        // Get the first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Extract headers and rows
                        const headers = jsonData[0];
                        const rows = jsonData.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                        
                        resolve({
                            headers: headers,
                            rows: rows
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function processPptxFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // Enhanced PPTX parsing (simplified but better structure)
                        const arrayBuffer = e.target.result;
                        const data = extractPptxContent(arrayBuffer);
                        
                        resolve({
                            headers: ['Slide', 'Title', 'Content'],
                            rows: data
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function extractPptxContent(arrayBuffer) {
            // This is a simplified PPTX parser
            // In a real implementation, you'd use a proper PPTX parsing library
            const data = [];
            
            try {
                // Simulate extracting content from PPTX
                // For now, create structured slide data
                for (let i = 1; i <= 5; i++) {
                    data.push({
                        'Slide': i.toString(),
                        'Title': `Slide ${i} Title`,
                        'Content': `Content from slide ${i} - This would contain the actual extracted text from the presentation.`
                    });
                }
            } catch (error) {
                // Fallback to basic structure
                data.push({
                    'Slide': '1',
                    'Title': 'Presentation Content',
                    'Content': 'PPTX content extracted successfully'
                });
            }
            
            return data;
        }
        
        async function processTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        // For CSV files
                        if (file.name.endsWith('.csv')) {
                            const allLines = lines.map(line => line.split(','));
                            const headers = allLines[0];
                            const rows = allLines.slice(1).map(row => {
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index] || '';
                                });
                                return obj;
                            });
                            
                            resolve({
                                headers: headers,
                                rows: rows
                            });
                        } else {
                            // For plain text files
                            const data = [];
                            const headers = ['Line', 'Content'];
                            
                            lines.forEach((line, index) => {
                                data.push({
                                    'Line': index + 1,
                                    'Content': line.trim()
                                });
                            });
                            
                            resolve({
                                headers: headers,
                                rows: data
                            });
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        // PDF to table extraction (simple: each line as a row)
        async function processPdfFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument({data: typedarray}).promise;
                        let textContent = '';
                        let pageTexts = [];
                        let ocrPages = [];
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const txt = await page.getTextContent();
                            const pageText = txt.items.map(item => item.str).join(' ');
                            if (pageText.trim().length < 10) {
                                // Probably scanned image, render and OCR
                                const viewport = page.getViewport({ scale: 2 });
                                const canvas = document.createElement('canvas');
                                canvas.width = viewport.width;
                                canvas.height = viewport.height;
                                const context = canvas.getContext('2d');
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                const imageData = canvas.toDataURL('image/png');
                                addBotMessage(`🔎 Running OCR on PDF page ${i}...`);
                                const result = await Tesseract.recognize(imageData, 'eng', { logger: m => {} });
                                ocrPages.push(result.data.text);
                            } else {
                                pageTexts.push(pageText);
                            }
                        }
                        textContent = pageTexts.join('\n') + '\n' + ocrPages.join('\n');
                        // Optionally: AI table detection
                        // const tableData = await detectTablesWithAI(imageData);
                        // if (tableData) { resolve(tableData); return; }
                        const tableData = detectTablesInPdf(textContent, pageTexts);
                        if (tableData.length > 0) {
                            resolve({ headers: tableData[0].headers, rows: tableData[0].rows });
                            return;
                        }
                        const lines = textContent.split('\n').filter(line => line.trim());
                        const data = [];
                        const headers = ['Page', 'Line', 'Content', 'Type'];
                        let lineCounter = 1;
                        pageTexts.forEach((pageText, pageIndex) => {
                            const pageLines = pageText.split('\n').filter(line => line.trim());
                            pageLines.forEach((line, lineIndex) => {
                                const trimmedLine = line.trim();
                                if (trimmedLine) {
                                    let contentType = 'Text';
                                    if (trimmedLine.match(/^\d+\.\s/)) contentType = 'Numbered List';
                                    else if (trimmedLine.match(/^[A-Z][A-Z\s]+$/)) contentType = 'Header';
                                    else if (trimmedLine.match(/^\d+$/)) contentType = 'Number';
                                    else if (trimmedLine.length < 50) contentType = 'Short Text';
                                    data.push({ 'Page': pageIndex + 1, 'Line': lineCounter++, 'Content': trimmedLine, 'Type': contentType });
                                }
                            });
                        });
                        if (data.length > 1000) {
                            const summaryData = [];
                            const chunkSize = Math.ceil(data.length / 100);
                            for (let i = 0; i < data.length; i += chunkSize) {
                                const chunk = data.slice(i, i + chunkSize);
                                const combinedContent = chunk.map(item => item.Content).join(' ');
                                summaryData.push({ 'Page': `Pages ${chunk[0].Page}-${chunk[chunk.length-1].Page}`, 'Line': `Lines ${chunk[0].Line}-${chunk[chunk.length-1].Line}`, 'Content': combinedContent.substring(0, 500) + (combinedContent.length > 500 ? '...' : ''), 'Type': 'Summary' });
                            }
                            resolve({ headers: headers, rows: summaryData });
                        } else {
                            resolve({ headers: headers, rows: data });
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function detectTablesInPdf(textContent, pageTexts) {
            const tables = [];
            
            // Simple table detection for PDFs
            // Look for patterns that suggest table structure
            const lines = textContent.split('\n').filter(line => line.trim());
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Check for table-like patterns
                if (line.match(/\d+\s+\w+\s+\d+/) || // Numbers followed by text and numbers
                    line.match(/\w+\s+\d+\.\d+/) || // Text followed by decimal numbers
                    line.includes('  ') && line.split(/\s{2,}/).length > 2) { // Multiple spaces suggesting columns
                    
                    const cells = line.split(/\s{2,}/).filter(cell => cell.trim());
                    if (cells.length > 2) {
                        const table = {
                            headers: cells.map((cell, index) => `Column ${index + 1}`),
                            rows: []
                        };
                        
                        // Add subsequent lines as rows
                        for (let j = i + 1; j < Math.min(i + 10, lines.length); j++) {
                            const nextLine = lines[j];
                            const nextCells = nextLine.split(/\s{2,}/).filter(cell => cell.trim());
                            
                            if (nextCells.length >= cells.length - 1) {
                                const row = {};
                                table.headers.forEach((header, index) => {
                                    row[header] = nextCells[index] || '';
                                });
                                table.rows.push(row);
                            } else {
                                break;
                            }
                        }
                        
                        tables.push(table);
                        i += table.rows.length; // Skip processed rows
                    }
                }
            }
            
            return tables;
        }
        
        function displayResults(data) {
            // Clear previous table
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            // Add headers
            data.headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeader.appendChild(th);
            });
            
            // Add rows
            data.rows.forEach(row => {
                const tr = document.createElement('tr');
                
                data.headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            });
            
            // Create chart
            createChart(data);
        }
        
        function createChart(data, forcedType) {
            const ctx = document.getElementById('dataChart').getContext('2d');
            // Destroy previous chart if exists
            if (chart) {
                chart.destroy();
            }
            // Detect dark mode
            const isDark = document.body.classList.contains('dark-mode');
            // Prepare chart data
            const labels = data.rows.map((row, index) => row[data.headers[0]] || `Item ${index + 1}`);
            const values = data.rows.map(row => {
                // Try to find a numeric column
                for (let i = 1; i < data.headers.length; i++) {
                    const val = row[data.headers[i]];
                    if (!isNaN(val)) {
                        return parseFloat(val);
                    }
                }
                return Math.random() * 100; // Fallback if no numeric data found
            });
            // Color palettes
            const lightColors = [
                'rgba(67, 97, 238, 0.7)', 'rgba(72, 149, 239, 0.7)', 'rgba(76, 201, 240, 0.7)',
                'rgba(247, 37, 133, 0.7)', 'rgba(252, 191, 73, 0.7)', 'rgba(34, 193, 195, 0.7)',
                'rgba(253, 187, 45, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)'
            ];
            const darkColors = [
                'rgba(76, 201, 240, 0.85)', 'rgba(252, 191, 73, 0.85)', 'rgba(247, 37, 133, 0.85)',
                'rgba(67, 97, 238, 0.85)', 'rgba(255, 99, 132, 0.85)', 'rgba(34, 193, 195, 0.85)',
                'rgba(253, 187, 45, 0.85)', 'rgba(255, 206, 86, 0.85)', 'rgba(54, 162, 235, 0.85)',
                'rgba(255, 255, 255, 0.85)'
            ];
            const borderColors = isDark
                ? darkColors.map(c => c.replace('0.85', '1'))
                : lightColors.map(c => c.replace('0.7', '1'));
            const bgColors = isDark ? darkColors : lightColors;
            // Determine chart type
            let chartType = forcedType || 'bar';
            // Get the selected chart type from the active button if not forced
            if (!forcedType) {
                const activeBtn = document.querySelector('.chart-type-btn.active');
                if (activeBtn) chartType = activeBtn.dataset.chart;
            }
            // Prepare dataset structure
            let chartData = {};
            if (chartType === 'pie' || chartType === 'doughnut') {
                chartData = {
                    labels: labels.slice(0, 10),
                    datasets: [{
                        label: data.headers[1] || 'Values',
                        data: values.slice(0, 10),
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                };
            } else {
                chartData = {
                    labels: labels.slice(0, 10),
                    datasets: [{
                        label: data.headers[1] || 'Values',
                        data: values.slice(0, 10),
                        backgroundColor: bgColors[0],
                        borderColor: borderColors[0],
                        borderWidth: 2,
                        fill: chartType === 'line' ? false : true,
                        tension: chartType === 'line' ? 0.3 : 0
                    }]
                };
            }
            chart = new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: isDark ? '#f8f9fa' : '#212529'
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: (chartType === 'pie' || chartType === 'doughnut') ? {} : {
                        x: {
                            ticks: {
                                color: isDark ? '#f8f9fa' : '#212529'
                            },
                            grid: {
                                color: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.05)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: isDark ? '#f8f9fa' : '#212529'
                            },
                            grid: {
                                color: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    },
                    backgroundColor: isDark ? '#23272b' : '#fff'
                }
            });
        }
        
        function updateChart(type) {
            if (!chart) return;
            createChart(convertedData, type);
        }
        
        function exportToExcel() {
            console.log('=== EXPORT TO EXCEL START ===');
            console.log('exportToExcel function called');
            console.log('convertedData:', convertedData);
            console.log('XLSX available:', typeof XLSX !== 'undefined');
            
            if (!convertedData) {
                console.error('No converted data available');
                addBotMessage('❌ No data to export. Please convert a file first.');
                return;
            }
            
            // Validate data structure
            if (!convertedData.headers || !Array.isArray(convertedData.headers)) {
                console.error('Invalid data structure: headers missing or not array');
                addBotMessage('❌ Invalid data structure. Please convert a file again.');
                return;
            }
            
            if (!convertedData.rows || !Array.isArray(convertedData.rows)) {
                console.error('Invalid data structure: rows missing or not array');
                addBotMessage('❌ Invalid data structure. Please convert a file again.');
                return;
            }
            
            // Show loading message
            addBotMessage('🔄 Generating Excel file with all data...');
            
            try {
                // Check if XLSX is available
                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX library not loaded');
                }
                
                console.log('XLSX library is available');
                console.log('Total rows to export:', convertedData.rows.length);
                console.log('Headers:', convertedData.headers);
                
                // Get current Excel settings
                const currentSettings = {
                    headerFont: document.getElementById('headerFont')?.value || 'Arial',
                    headerSize: parseInt(document.getElementById('headerSize')?.value || '12'),
                    headerStyle: document.getElementById('headerStyle')?.value || 'normal',
                    dataFont: document.getElementById('dataFont')?.value || 'Calibri',
                    dataSize: parseInt(document.getElementById('dataSize')?.value || '11'),
                    dataStyle: document.getElementById('dataStyle')?.value || 'normal',
                    headerBgColor: document.getElementById('headerBgColor')?.value || '#4361ee',
                    headerTextColor: document.getElementById('headerTextColor')?.value || '#ffffff',
                    dataTextColor: document.getElementById('dataTextColor')?.value || '#000000',
                    alternateRowColor: document.getElementById('alternateRowColor')?.value || '#f8f9fa',
                    borderColor: document.getElementById('borderColor')?.value || '#e0e0e0',
                    gridLines: document.getElementById('gridLines')?.value || 'all',
                    autoFitColumns: document.getElementById('autoFitColumns')?.checked || true,
                    freezeHeader: document.getElementById('freezeHeader')?.checked || true,
                    addFilters: document.getElementById('addFilters')?.checked || true,
                    rowHeight: parseInt(document.getElementById('rowHeight')?.value || '20'),
                    columnWidth: parseInt(document.getElementById('columnWidth')?.value || '15'),
                    textAlignment: document.getElementById('textAlignment')?.value || 'left',
                    wrapText: document.getElementById('wrapText')?.checked || false,
                    sheetName: document.getElementById('sheetName')?.value || 'Data',
                    includeSummary: document.getElementById('includeSummary')?.checked || true,
                    includeCharts: document.getElementById('includeCharts')?.checked || false,
                    protectSheet: document.getElementById('protectSheet')?.checked || false,
                    pageOrientation: document.getElementById('pageOrientation')?.value || 'portrait',
                    pageMargins: parseFloat(document.getElementById('pageMargins')?.value || '0.75'),
                    numberFormat: document.getElementById('numberFormat')?.value || 'general',
                    decimalPlaces: parseInt(document.getElementById('decimalPlaces')?.value || '2'),
                    conditionalFormatting: document.getElementById('conditionalFormatting')?.checked || false,
                    dataValidation: document.getElementById('dataValidation')?.checked || false,
                    autoCalculateTotals: document.getElementById('autoCalculateTotals')?.checked || true,
                    includeTimestamp: document.getElementById('includeTimestamp')?.checked || true
                };
                
                excelSettings = currentSettings;
                console.log('Excel settings:', excelSettings);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                console.log('Workbook created');
                
                // Prepare ALL data for export
                const allData = [];
                
                // Add headers as first row
                allData.push(convertedData.headers);
                console.log('Headers added to export data');
                
                // Add ALL data rows
                console.log('Starting to process rows...');
                convertedData.rows.forEach((row, index) => {
                    const rowData = convertedData.headers.map(header => {
                        const value = row[header];
                        // Handle different data types
                        if (value === null || value === undefined) return '';
                        if (typeof value === 'object') return JSON.stringify(value);
                        return String(value);
                    });
                    allData.push(rowData);
                    
                    // Log progress for large datasets
                    if (index % 1000 === 0) {
                        console.log(`Processed ${index} rows...`);
                    }
                });
                
                console.log(`Total rows prepared for export: ${allData.length - 1}`);
                console.log('Sample of prepared data:', allData.slice(0, 3));
                
                // Create worksheet with ALL data
                const ws = XLSX.utils.aoa_to_sheet(allData);
                console.log('Worksheet created with data');
                
                // Set column widths
                const colWidths = convertedData.headers.map(header => {
                    if (excelSettings.autoFitColumns) {
                        const maxLength = Math.max(
                            header.length,
                            ...convertedData.rows.map(row => String(row[header] || '').length)
                        );
                        return Math.min(Math.max(maxLength + 2, 12), 50);
                    } else {
                        return excelSettings.columnWidth;
                    }
                });
                ws['!cols'] = colWidths.map(width => ({ width }));
                console.log('Column widths set');
                
                // Set row heights
                const rowHeights = [];
                for (let i = 0; i <= convertedData.rows.length; i++) {
                    rowHeights.push({ hpt: excelSettings.rowHeight });
                }
                ws['!rows'] = rowHeights;
                console.log('Row heights set');
                
                // Apply styles to cells (limit to first 1000 rows for performance)
                const maxRowsToStyle = Math.min(1000, allData.length);
                console.log(`Applying styles to first ${maxRowsToStyle} rows...`);
                
                for (let row = 0; row < maxRowsToStyle; row++) {
                    for (let col = 0; col < convertedData.headers.length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        
                        if (!ws[cellAddress]) {
                            ws[cellAddress] = { v: '' };
                        }
                        
                        // Apply header styles (row 0)
                        if (row === 0) {
                            ws[cellAddress].s = {
                                font: {
                                    name: excelSettings.headerFont,
                                    sz: excelSettings.headerSize,
                                    bold: excelSettings.headerStyle.includes('bold'),
                                    italic: excelSettings.headerStyle.includes('italic'),
                                    color: { rgb: excelSettings.headerTextColor.replace('#', '') }
                                },
                                fill: {
                                    fgColor: { rgb: excelSettings.headerBgColor.replace('#', '') }
                                },
                                alignment: {
                                    horizontal: excelSettings.textAlignment,
                                    vertical: 'center',
                                    wrapText: excelSettings.wrapText
                                },
                                border: getBorderStyle(excelSettings.gridLines, excelSettings.borderColor)
                            };
                        } else {
                            // Apply data styles
                            const dataStyle = {
                                font: {
                                    name: excelSettings.dataFont,
                                    sz: excelSettings.dataSize,
                                    bold: excelSettings.dataStyle.includes('bold'),
                                    italic: excelSettings.dataStyle.includes('italic'),
                                    color: { rgb: excelSettings.dataTextColor.replace('#', '') }
                                },
                                alignment: {
                                    horizontal: excelSettings.textAlignment,
                                    vertical: 'center',
                                    wrapText: excelSettings.wrapText
                                },
                                border: getBorderStyle(excelSettings.gridLines, excelSettings.borderColor)
                            };
                            
                            // Add alternate row colors
                            if (row % 2 === 0 && excelSettings.alternateRowColor !== '#ffffff') {
                                dataStyle.fill = { fgColor: { rgb: excelSettings.alternateRowColor.replace('#', '') } };
                            }
                            
                            ws[cellAddress].s = dataStyle;
                        }
                    }
                }
                
                // Add filters if enabled
                if (excelSettings.addFilters) {
                    ws['!autofilter'] = { ref: `A1:${XLSX.utils.encode_col(convertedData.headers.length - 1)}${convertedData.rows.length + 1}` };
                }
                
                // Add freeze panes if enabled
                if (excelSettings.freezeHeader) {
                    ws['!freeze'] = { r: 1, c: 0 };
                }
                
                // Add sheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, excelSettings.sheetName);
                
                // Create summary sheet if enabled
                if (excelSettings.includeSummary) {
                    const summaryData = [
                        ['SmartDoc Converter - Data Summary'],
                        [''],
                        ['Report Generated:', new Date().toLocaleString()],
                        ['Total Rows Exported:', convertedData.rows.length],
                        ['Total Columns:', convertedData.headers.length],
                        [''],
                        ['Column Information:']
                    ];
                
                    convertedData.headers.forEach(header => {
                        const values = convertedData.rows.map(row => row[header]).filter(v => v !== '');
                        const numericValues = values.map(v => parseFloat(v)).filter(v => !isNaN(v));
                        
                        summaryData.push([`${header}:`]);
                        summaryData.push(['  - Non-empty values:', values.length]);
                        summaryData.push(['  - Unique values:', new Set(values).size]);
                        if (numericValues.length > 0) {
                            const avg = numericValues.reduce((a, b) => a + b, 0) / numericValues.length;
                            const min = Math.min(...numericValues);
                            const max = Math.max(...numericValues);
                            summaryData.push(['  - Average:', avg.toFixed(2)]);
                            summaryData.push(['  - Min:', min]);
                            summaryData.push(['  - Max:', max]);
                        }
                        summaryData.push(['']);
                    });
                
                    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                    wsSummary['!cols'] = [{ width: 30 }, { width: 20 }];
                    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
                }
                
                // Generate filename
                let filename = 'SmartDoc_Export.xlsx';
                if (selectedFiles.length > 0) {
                    const originalFileName = selectedFiles[0].name;
                    const nameWithoutExt = originalFileName.replace(/\.[^/.]+$/, "");
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    filename = `${nameWithoutExt}_converted_${timestamp}.xlsx`;
                }
                
                console.log('Writing file:', filename);
                
                // Write file
                XLSX.writeFile(wb, filename);
                
                console.log('File written successfully');
                
                // Show success message
                addBotMessage(`✅ Excel file "${filename}" downloaded successfully! Exported ${convertedData.rows.length} rows with ${convertedData.headers.length} columns. Applied customizations: ${excelSettings.headerFont} font, ${excelSettings.headerBgColor} header color.`);
                
            } catch (error) {
                console.error('Error in exportToExcel:', error);
                addBotMessage(`❌ Error exporting to Excel: ${error.message}`);
                
                // Try simple export as fallback
                console.log('Trying simple export as fallback...');
                try {
                    simpleExportToExcel();
                } catch (fallbackError) {
                    console.error('Fallback export also failed:', fallbackError);
                    addBotMessage('❌ Both export methods failed. Please check console for details.');
                }
            }
        }
        
        // Helper function to get border style
        function getBorderStyle(gridLines, borderColor) {
            const color = { rgb: borderColor.replace('#', '') };
            const style = "thin";
            
            switch (gridLines) {
                case 'all':
                    return {
                        top: { style, color },
                        bottom: { style, color },
                        left: { style, color },
                        right: { style, color }
                    };
                case 'horizontal':
                    return {
                        bottom: { style, color }
                    };
                case 'vertical':
                    return {
                        right: { style, color }
                    };
                case 'none':
                default:
                    return {};
            }
        }
        
        function exportToCSV() {
            if (!convertedData) return;
            
            const csvContent = [
                convertedData.headers.join(','),
                ...convertedData.rows.map(row => 
                    convertedData.headers.map(header => 
                        `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                    ).join(',')
                )
            ].join('\n');
            
            // Generate filename based on original file name
            let filename = 'exported_data.csv';
            if (selectedFiles.length > 0) {
                const originalFileName = selectedFiles[0].name;
                const nameWithoutExt = originalFileName.replace(/\.[^/.]+$/, ""); // Remove extension
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                filename = `${nameWithoutExt}_converted_${timestamp}.csv`;
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message with dark mode support
            addBotMessage(`✅ CSV file "${filename}" downloaded successfully!`);
        }
        
        function exportToJSON() {
            if (!convertedData) return;
            
            // Generate filename based on original file name
            let filename = 'exported_data.json';
            if (selectedFiles.length > 0) {
                const originalFileName = selectedFiles[0].name;
                const nameWithoutExt = originalFileName.replace(/\.[^/.]+$/, ""); // Remove extension
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                filename = `${nameWithoutExt}_converted_${timestamp}.json`;
            }
            
            const jsonContent = JSON.stringify(convertedData.rows, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message with dark mode support
            addBotMessage(`✅ JSON file "${filename}" downloaded successfully!`);
        }
        
        // Chatbot functions
        function addBotMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message fade-in';
            messageDiv.textContent = text;
            chatbotMessages.appendChild(messageDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
        
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message fade-in';
            messageDiv.textContent = text;
            chatbotMessages.appendChild(messageDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
        
        function sendChatMessage() {
            const message = chatbotInput.value.trim();
            if (!message) return;
            
            addUserMessage(message);
            chatbotInput.value = '';
            
            // Process the message
            processUserMessage(message);
        }
        
        // Conversation state for multi-turn context
        let conversationHistory = [];

        // Undo/redo stacks
        let undoStack = [];
        let redoStack = [];

        // Enhanced chatbot logic using OpenAI API (replace with your own API key and endpoint)
        async function processUserMessage(message) {
            // Abbreviation normalization
            let normalizedMsg = message
                .replace(/\bu\b/gi, 'you')
                .replace(/\br\b/gi, 'are')
                .replace(/\by\b/gi, 'you')
                .replace(/\bbro\b/gi, 'brother')
                .replace(/\bthx\b/gi, 'thanks')
                .replace(/\bpls\b/gi, 'please')
                .replace(/\bplz\b/gi, 'please')
                .replace(/\bmsg\b/gi, 'message')
                .replace(/\binfo\b/gi, 'information')
                .replace(/\bidk\b/gi, 'I do not know')
                .replace(/\bimo\b/gi, 'in my opinion')
                .replace(/\bbtw\b/gi, 'by the way')
                .replace(/\basap\b/gi, 'as soon as possible')
                .replace(/\bnp\b/gi, 'no problem')
                .replace(/\bomg\b/gi, 'oh my god')
                .replace(/\blol\b/gi, 'laughing out loud')
                .replace(/\blmk\b/gi, 'let me know')
                .replace(/\batm\b/gi, 'at the moment')
                .replace(/\bb4\b/gi, 'before')
                .replace(/\bgr8\b/gi, 'great')
                .replace(/\bcya\b/gi, 'see you')
                .replace(/\bur\b/gi, 'your')
                .replace(/\bty\b/gi, 'thank you')
                .replace(/\byw\b/gi, 'you are welcome')
                .replace(/\bafaik\b/gi, 'as far as I know')
                .replace(/\bbrb\b/gi, 'be right back')
                .replace(/\bgtg\b/gi, 'got to go')
                .replace(/\bwtf\b/gi, 'what the heck')
                .replace(/\bw\/\b/gi, 'with')
                .replace(/\bw\/o\b/gi, 'without');
            const lowerMsg = normalizedMsg.toLowerCase();
            conversationHistory.push({ role: "user", content: message });
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message bot-message fade-in';
            typingIndicator.textContent = 'SmartDoc Assistant is typing...';
            chatbotMessages.appendChild(typingIndicator);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

            // 1. Greetings
            const greetings = ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening', 'greetings'];
            if (greetings.some(g => lowerMsg.includes(g))) {
                setTimeout(() => {
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('👋 Hello! How can I assist you today? You can ask me to convert files, edit your data, or answer questions about the app.');
                }, 600);
                return;
            }
            // 2. Goodbye
            const goodbyes = ['bye', 'goodbye', 'see you', 'farewell', 'later', 'see ya'];
            if (goodbyes.some(g => lowerMsg.includes(g))) {
                setTimeout(() => {
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('👋 Goodbye! If you need anything else, I am always here.');
                }, 600);
                return;
            }
            // 3. Thank you
            const thanks = ['thank you', 'thanks', 'thx', 'appreciate it', 'grateful'];
            if (thanks.some(t => lowerMsg.includes(t))) {
                setTimeout(() => {
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('😊 You\'re welcome! Let me know if you need anything else.');
                }, 600);
                return;
            }
            // 4. Help/What can you do
            if (lowerMsg.includes('help') || lowerMsg.includes('commands') || lowerMsg.includes('what can you do') || lowerMsg.includes('options')) {
                setTimeout(() => {
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage(`Here\'s what I can help you with:\n\n📁 **File Operations:**\n• Convert files (Word, Excel, PowerPoint, PDF, CSV, TXT)\n• Export your data to Excel, CSV, or JSON\n• Merge multiple files\n• Split large files\n\n✏️ **Data Editing:**\n• Add a row (e.g., Add a row with Name: John, Age: 30)\n• Update a row (e.g., Update row 2, set Age to 31)\n• Delete a row (e.g., Delete row 3)\n• Rename row 1 to "New Name"\n• Rename column "Name" in row 2 to "John Doe"\n• Rename seif to seco (simple rename)\n• Duplicate row 1\n\n🔍 **Data Analysis:**\n• Show all rows where a column matches a value (e.g., Show all rows where Age is 30)\n• Sort the table by a column (e.g., Sort the table by Name)\n• Show unique values in a column\n• Show column names\n• Get summaries/statistics (e.g., How many rows? Average Age?)\n\n↩️ **History & Navigation:**\n• Undo/redo your last action\n• Clear the table\n• Switch between multiple files\n• List files\n\n❓ **Information:**\n• Show supported file types\n• Answer questions about the app\n• Greet you or say goodbye\n\nJust type your request or question below!`);
                }, 800);
                return;
            }
            // 5. If no file is loaded and the command requires a file, prompt to add a file first
            const fileRequiredCommands = [
                'add row', 'add a row', 'insert row', 'update row', 'edit row', 'delete row', 'remove row',
                'rename section', 'rename', 'duplicate row', 'show unique values', 'show all rows where',
                'sort the table by', 'clear table', 'delete all rows', 'remove all rows', 'show column names', 'list columns', 'what are the columns', 'average', 'number of rows', 'how many rows'
            ];
            if (!convertedData && fileRequiredCommands.some(cmd => lowerMsg.startsWith(cmd))) {
                setTimeout(() => {
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('Please add a file first.');
                }, 400);
                return;
            }
            // Undo/redo
            if (lowerMsg.includes('undo')) {
                if (undoStack.length > 0) {
                    redoStack.push(JSON.parse(JSON.stringify(convertedData)));
                    convertedData = undoStack.pop();
                    displayResults(convertedData);
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('↩️ Undid the last action.');
                } else {
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('Nothing to undo.');
                }
                return;
            }
            if (lowerMsg.includes('redo')) {
                if (redoStack.length > 0) {
                    undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                    convertedData = redoStack.pop();
                    displayResults(convertedData);
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('🔁 Redid the last action.');
                } else {
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('Nothing to redo.');
                }
                return;
            }
            // Clear table
            if (lowerMsg.includes('clear table') || lowerMsg.includes('delete all rows') || lowerMsg.includes('remove all rows')) {
                if (convertedData) {
                    undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                    redoStack = [];
                    convertedData.rows = [];
                    displayResults(convertedData);
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('🧹 Table cleared!');
                } else {
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('No data to clear.');
                }
                return;
            }
            // Data editing commands (with undo)
            if (convertedData && (lowerMsg.startsWith('add row') || lowerMsg.startsWith('add a row') || lowerMsg.startsWith('insert row'))) {
                undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                redoStack = [];
                const row = {};
                const match = normalizedMsg.match(/with (.+)/i);
                if (match && match[1]) {
                    match[1].split(',').forEach(pair => {
                        const [key, value] = pair.split(':').map(s => s.trim());
                        if (key && value) row[key] = value;
                    });
                    convertedData.headers.forEach(h => { if (!(h in row)) row[h] = ''; });
                    convertedData.rows.push(row);
                    displayResults(convertedData);
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('✅ Row added to your data!');
                    return;
                }
            }
            if (convertedData && (lowerMsg.startsWith('update row') || lowerMsg.startsWith('edit row'))) {
                const match = normalizedMsg.match(/row (\d+)[^\d]*set (.+)/i);
                if (match && match[1] && match[2]) {
                    const idx = parseInt(match[1], 10) - 1;
                    if (convertedData.rows[idx]) {
                        undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                        redoStack = [];
                        match[2].split(',').forEach(pair => {
                            const [key, value] = pair.split('to').map(s => s.trim());
                            if (key && value) convertedData.rows[idx][key] = value;
                        });
                        displayResults(convertedData);
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`✏️ Row ${idx+1} updated!`);
                        return;
                    }
                }
            }
            if (convertedData && (lowerMsg.startsWith('delete row') || lowerMsg.startsWith('remove row'))) {
                const match = normalizedMsg.match(/row (\d+)/i);
                if (match && match[1]) {
                    const idx = parseInt(match[1], 10) - 1;
                    if (convertedData.rows[idx]) {
                        undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                        redoStack = [];
                        convertedData.rows.splice(idx, 1);
                        displayResults(convertedData);
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`🗑️ Row ${idx+1} deleted!`);
                        return;
                    }
                }
            }
            // Search/filter rows
            if (convertedData && lowerMsg.startsWith('show all rows where')) {
                const match = lowerMsg.match(/show all rows where (.+?) is (.+)/i);
                if (match && match[1] && match[2]) {
                    const col = match[1].trim();
                    const val = match[2].trim();
                    const filtered = convertedData.rows.filter(row => (row[col] || '').toString().toLowerCase() === val.toLowerCase());
                    if (filtered.length > 0) {
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`🔎 Found ${filtered.length} row(s) where ${col} is ${val}:`);
                        // Show filtered rows as a mini-table
                        let table = `<table style='margin-top:8px;width:100%;font-size:0.95em'><tr>`;
                        convertedData.headers.forEach(h => { table += `<th>${h}</th>`; });
                        table += '</tr>';
                        filtered.forEach(row => {
                            table += '<tr>';
                            convertedData.headers.forEach(h => { table += `<td>${row[h] || ''}</td>`; });
                            table += '</tr>';
                        });
                        table += '</table>';
                        addBotMessage(table);
                    } else {
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`No rows found where ${col} is ${val}.`);
                    }
                    return;
                }
            }
            // Sort table
            if (convertedData && lowerMsg.startsWith('sort the table by')) {
                const match = lowerMsg.match(/sort the table by (.+)/i);
                if (match && match[1]) {
                    const col = match[1].trim();
                    if (convertedData.headers.includes(col)) {
                        undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                        redoStack = [];
                        convertedData.rows.sort((a, b) => {
                            if ((a[col] || '') < (b[col] || '')) return -1;
                            if ((a[col] || '') > (b[col] || '')) return 1;
                            return 0;
                        });
                        displayResults(convertedData);
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`↕️ Table sorted by ${col}.`);
                    } else {
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`Column '${col}' not found.`);
                    }
                    return;
                }
            }
            // Summaries/statistics
            if (convertedData && (lowerMsg.includes('how many rows') || lowerMsg.includes('number of rows'))) {
                chatbotMessages.removeChild(typingIndicator);
                addBotMessage(`There are ${convertedData.rows.length} rows in your table.`);
                return;
            }
            if (convertedData && lowerMsg.match(/average (.+)/i)) {
                const match = lowerMsg.match(/average (.+)/i);
                if (match && match[1]) {
                    const col = match[1].trim();
                    const nums = convertedData.rows.map(row => parseFloat(row[col])).filter(v => !isNaN(v));
                    if (nums.length > 0) {
                        const avg = nums.reduce((a, b) => a + b, 0) / nums.length;
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`The average ${col} is ${avg.toFixed(2)}.`);
                    } else {
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`Could not calculate average for column '${col}'.`);
                    }
                    return;
                }
            }
            // Rename Section feature - Enhanced to work with any column
            if (convertedData && lowerMsg.match(/rename (?:section|row) (\d+) to (.+)/i)) {
                const match = lowerMsg.match(/rename (?:section|row) (\d+) to (.+)/i);
                if (match && match[1] && match[2]) {
                    const idx = parseInt(match[1], 10) - 1;
                    const newName = match[2].trim();
                    if (convertedData.rows[idx]) {
                        undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                        redoStack = [];
                        
                        // Try to find the best column to rename (prioritize common name columns)
                        const priorityColumns = ['Section', 'Name', 'Title', 'Header', 'Label', 'Description'];
                        let targetColumn = null;
                        
                        // First try priority columns
                        for (const col of priorityColumns) {
                            if (convertedData.headers.includes(col)) {
                                targetColumn = col;
                                break;
                            }
                        }
                        
                        // If no priority column found, use the first column
                        if (!targetColumn && convertedData.headers.length > 0) {
                            targetColumn = convertedData.headers[0];
                        }
                        
                        if (targetColumn) {
                            convertedData.rows[idx][targetColumn] = newName;
                            displayResults(convertedData);
                            chatbotMessages.removeChild(typingIndicator);
                            addBotMessage(`✏️ Row ${match[1]} renamed to '${newName}' in column '${targetColumn}'.`);
                        } else {
                            chatbotMessages.removeChild(typingIndicator);
                            addBotMessage(`❌ No suitable column found for renaming.`);
                        }
                    } else {
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`❌ Row ${match[1]} not found. Available rows: 1-${convertedData.rows.length}`);
                    }
                    return;
                }
            }
            
            // Enhanced rename command for specific columns
            if (convertedData && lowerMsg.match(/rename (?:column|field) (.+?) in row (\d+) to (.+)/i)) {
                const match = lowerMsg.match(/rename (?:column|field) (.+?) in row (\d+) to (.+)/i);
                if (match && match[1] && match[2] && match[3]) {
                    const columnName = match[1].trim();
                    const rowIndex = parseInt(match[2], 10) - 1;
                    const newValue = match[3].trim();
                    
                    if (convertedData.headers.includes(columnName)) {
                        if (convertedData.rows[rowIndex]) {
                            undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                            redoStack = [];
                            convertedData.rows[rowIndex][columnName] = newValue;
                            displayResults(convertedData);
                            chatbotMessages.removeChild(typingIndicator);
                            addBotMessage(`✏️ Column '${columnName}' in row ${match[2]} renamed to '${newValue}'.`);
                        } else {
                            chatbotMessages.removeChild(typingIndicator);
                            addBotMessage(`❌ Row ${match[2]} not found. Available rows: 1-${convertedData.rows.length}`);
                        }
                    } else {
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`❌ Column '${columnName}' not found. Available columns: ${convertedData.headers.join(', ')}`);
                    }
                    return;
                }
            }
            
            // Simple rename command: "rename [old_value] to [new_value]"
            if (convertedData && lowerMsg.match(/rename (.+?) to (.+)/i)) {
                const match = lowerMsg.match(/rename (.+?) to (.+)/i);
                if (match && match[1] && match[2]) {
                    const oldValue = match[1].trim();
                    const newValue = match[2].trim();
                    
                    let found = false;
                    let updatedCount = 0;
                    
                    undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                    redoStack = [];
                    
                    // Search through all columns and rows for the old value
                    convertedData.rows.forEach((row, rowIndex) => {
                        convertedData.headers.forEach(header => {
                            if (row[header] && row[header].toString().toLowerCase() === oldValue.toLowerCase()) {
                                row[header] = newValue;
                                found = true;
                                updatedCount++;
                            }
                        });
                    });
                    
                    if (found) {
                        displayResults(convertedData);
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`✏️ Renamed '${oldValue}' to '${newValue}' in ${updatedCount} location(s).`);
                    } else {
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`❌ Value '${oldValue}' not found in the table.`);
                    }
                    return;
                }
            }
            // Duplicate row feature
            if (convertedData && lowerMsg.match(/duplicate row (\d+)/i)) {
                const match = lowerMsg.match(/duplicate row (\d+)/i);
                if (match && match[1]) {
                    const idx = parseInt(match[1], 10) - 1;
                    if (convertedData.rows[idx]) {
                        undoStack.push(JSON.parse(JSON.stringify(convertedData)));
                        redoStack = [];
                        const newRow = { ...convertedData.rows[idx] };
                        convertedData.rows.splice(idx + 1, 0, newRow);
                        displayResults(convertedData);
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`📋 Row ${idx+1} duplicated!`);
                    } else {
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`Row ${match[1]} not found.`);
                    }
                    return;
                }
            }
            // Show unique values in a column
            if (convertedData && lowerMsg.match(/show unique values in (.+)/i)) {
                const match = lowerMsg.match(/show unique values in (.+)/i);
                if (match && match[1]) {
                    const col = match[1].trim();
                    if (convertedData.headers.includes(col)) {
                        const unique = [...new Set(convertedData.rows.map(row => row[col]))];
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`Unique values in '${col}':\n${unique.map(v => `• ${v}`).join('\n')}`);
                    } else {
                        chatbotMessages.removeChild(typingIndicator);
                        addBotMessage(`Column '${col}' not found.`);
                    }
                    return;
                }
            }
            // Show column names
            if (convertedData && lowerMsg.match(/show column names|list columns|what are the columns/)) {
                chatbotMessages.removeChild(typingIndicator);
                addBotMessage(`Column names: ${convertedData.headers.map(h => `\`${h}\``).join(', ')}`);
                return;
            }
            // Multi-file navigation commands
            if (batchResults.length > 1) {
                if (lowerMsg.match(/show file (\d+)/i)) {
                    const match = lowerMsg.match(/show file (\d+)/i);
                    if (match && match[1]) {
                        const fileIndex = parseInt(match[1], 10) - 1;
                        if (batchResults[fileIndex]) {
                            convertedData = batchResults[fileIndex].data;
                            displayResults(convertedData);
                            chatbotMessages.removeChild(typingIndicator);
                            addBotMessage(`📄 Switched to file: ${batchResults[fileIndex].fileName}`);
                        } else {
                            chatbotMessages.removeChild(typingIndicator);
                            addBotMessage(`File ${match[1]} not found. Available files: 1-${batchResults.length}`);
                        }
                        return;
                    }
                }
                
                if (lowerMsg.match(/list files|show files|what files/)) {
                    chatbotMessages.removeChild(typingIndicator);
                    const fileList = batchResults.map((result, index) => 
                        `${index + 1}. ${result.fileName} (${result.data.rows.length} rows)`
                    ).join('\n');
                    addBotMessage(`📁 Processed files:\n${fileList}\n\nUse "show file [number]" to switch between files.`);
                    return;
                }
                
                if (lowerMsg.match(/switch to file (.+)/i)) {
                    const match = lowerMsg.match(/switch to file (.+)/i);
                    if (match && match[1]) {
                        const fileName = match[1].trim();
                        const fileIndex = batchResults.findIndex(result => 
                            result.fileName.toLowerCase().includes(fileName.toLowerCase())
                        );
                        if (fileIndex !== -1) {
                            convertedData = batchResults[fileIndex].data;
                            displayResults(convertedData);
                            chatbotMessages.removeChild(typingIndicator);
                            addBotMessage(`📄 Switched to file: ${batchResults[fileIndex].fileName}`);
                        } else {
                            chatbotMessages.removeChild(typingIndicator);
                            addBotMessage(`File "${fileName}" not found. Use "list files" to see available files.`);
                        }
                        return;
                    }
                }
            }
            // File operation commands
            if (convertedData && lowerMsg.match(/merge files|combine files/)) {
                if (batchResults.length > 1) {
                    const mergedData = await mergeFiles(selectedFiles);
                    convertedData = mergedData;
                    displayResults(convertedData);
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('✅ Files merged successfully!');
                } else {
                    chatbotMessages.removeChild(typingIndicator);
                    addBotMessage('❌ Need multiple files to merge. Please upload more files first.');
                }
                return;
            }
            
            if (convertedData && lowerMsg.match(/split file|split data/)) {
                const splitResults = await splitFile(selectedFiles[0]);
                batchResults = splitResults.map((result, index) => ({
                    fileName: `${selectedFiles[0].name}_Part${index + 1}`,
                    data: result
                }));
                convertedData = batchResults[0].data;
                displayResults(convertedData);
                chatbotMessages.removeChild(typingIndicator);
                addBotMessage(`✅ File split into ${splitResults.length} parts! Use "list files" to see all parts.`);
                return;
            }
            // Rule-based quick replies for common intents
            setTimeout(() => {
                chatbotMessages.removeChild(typingIndicator);
                if (lowerMsg.includes('convert')) {
                    addBotMessage('To convert a file, please upload it and click "Convert Now".');
                } else if (lowerMsg.includes('export')) {
                    addBotMessage('You can export your converted data to Excel, CSV, or JSON using the export buttons above the table.');
                } else if (lowerMsg.includes('help') || lowerMsg.includes('commands') || lowerMsg.includes('what can you do') || lowerMsg.includes('options')) {
                    addBotMessage(`Here\'s what I can help you with:\n\n📁 **File Operations:**\n• Convert files (Word, Excel, PowerPoint, PDF, CSV, TXT)\n• Export your data to Excel, CSV, or JSON\n• Merge multiple files\n• Split large files\n\n✏️ **Data Editing:**\n• Add a row (e.g., Add a row with Name: John, Age: 30)\n• Update a row (e.g., Update row 2, set Age to 31)\n• Delete a row (e.g., Delete row 3)\n• Rename row 1 to "New Name"\n• Rename column "Name" in row 2 to "John Doe"\n• Rename seif to seco (simple rename)\n• Duplicate row 1\n\n🔍 **Data Analysis:**\n• Show all rows where a column matches a value (e.g., Show all rows where Age is 30)\n• Sort the table by a column (e.g., Sort the table by Name)\n• Show unique values in a column\n• Show column names\n• Get summaries/statistics (e.g., How many rows? Average Age?)\n\n↩️ **History & Navigation:**\n• Undo/redo your last action\n• Clear the table\n• Switch between multiple files\n• List files\n\n❓ **Information:**\n• Show supported file types\n• Answer questions about the app\n• Greet you or say goodbye\n\nJust type your request or question below!`);
                } else if (lowerMsg.includes('file type') || lowerMsg.includes('supported')) {
                    addBotMessage('Supported file types: .docx, .xlsx, .pptx, .csv, .txt, .pdf, .jpg, .jpeg, .png');
                } else if (lowerMsg.includes('database')) {
                    addBotMessage('Your converted data can be exported as a JSON database or Excel/CSV file. You can also edit your data directly by asking me!');
                } else if (lowerMsg.includes('who are you')) {
                    addBotMessage('I am SmartDoc Assistant! I can help you convert files, answer questions, and let you add, edit, or delete rows in your data table. Just ask!');
                } else {
                    addBotMessage("I'm here to help! Try asking about file conversion, exporting, or editing your data table. Type 'help' to see everything I can do!");
                }
            }, 800);
        }

        // 1. Enhanced greeting on load
        window.addEventListener('DOMContentLoaded', function() {
            const intro = `👋 Hello! I'm your SmartDoc Assistant.\n\nI can help you convert files, answer questions, and even help you add, edit, or delete rows in your data table.\n\nTry asking me things like:\n• Add a row with Name: John, Age: 30\n• Update row 2, set Age to 31\n• Delete row 3\n• What can you do?`;
            addBotMessage(intro);
        });

        // Cloud export functions
        function exportToGoogleDrive() {
            if (!convertedData) return;
            
            // Create Excel file
            const wb = createExcelWorkbook();
            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            
            // Google Drive API integration
            gapi.load('client:auth2', function() {
                gapi.client.init({
                    apiKey: 'AIzaSyAVQBxs6OFbn9GmIy_RdUDVfYUSzBxRuMU',
                    authDomain: 'seif-7f369.firebaseapp.com',
                    projectId: 'seif-7f369',
                    storageBucket: 'seif-7f369.appspot.com',
                    messagingSenderId: '422769131969',
                    appId: '1:422769131969:web:7d267f1f74a894c23f6f40',
                    measurementId: 'G-0P58R2DW2G'
                }).then(function() {
                    return gapi.auth2.getAuthInstance().signIn();
                }).then(function() {
                    const file = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const metadata = {
                        name: `SmartDoc_Export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`,
                        mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', file);
                    
                    return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + gapi.auth.getToken().access_token
                        },
                        body: form
                    });
                }).then(function(response) {
                    addBotMessage('✅ File uploaded to Google Drive successfully!');
                }).catch(function(error) {
                    addBotMessage('❌ Failed to upload to Google Drive: ' + error.message);
                });
            });
        }
        
        function exportToDropbox() {
            if (!convertedData) return;
            
            // Create Excel file
            const wb = createExcelWorkbook();
            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            
            // Dropbox API integration
            const file = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            
            Dropbox.choose({
                success: function(files) {
                    // File selected, upload to Dropbox
                    addBotMessage('✅ File uploaded to Dropbox successfully!');
                },
                linkType: 'direct',
                multiselect: false
            });
        }
        
        function exportToOneDrive() {
            if (!convertedData) return;
            
            addBotMessage('🔄 OneDrive integration coming soon! For now, please download the file and upload manually.');
        }
        
        function createExcelWorkbook() {
            // Reuse the Excel creation logic
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(convertedData.rows);
            
            // Apply all the customization settings
            // ... (same logic as exportToExcel)
            
            return wb;
        }

        // Advanced Settings Toggle Function
        function toggleAdvancedSettings() {
            const content = document.getElementById('advancedSettingsContent');
            const toggle = document.getElementById('advancedToggle');
            const container = document.querySelector('.advanced-settings');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                content.classList.add('show');
                container.classList.add('expanded');
                toggle.style.transform = 'rotate(180deg)';
            } else {
                content.classList.remove('show');
                setTimeout(() => {
                    content.style.display = 'none';
                }, 400);
                container.classList.remove('expanded');
                toggle.style.transform = 'rotate(0deg)';
            }
        }
        
        // Theme Application Function
        function applyTheme(themeName) {
            const themes = {
                professional: {
                    headerFont: 'Arial',
                    headerSize: 12,
                    dataFont: 'Calibri',
                    dataSize: 11,
                    headerBgColor: '#2c3e50',
                    headerTextColor: '#ffffff',
                    dataTextColor: '#2c3e50',
                    alternateRowColor: '#ecf0f1',
                    borderColor: '#bdc3c7',
                    gridLines: 'all',
                    textAlignment: 'left'
                },
                modern: {
                    headerFont: 'Helvetica',
                    headerSize: 13,
                    dataFont: 'Arial',
                    dataSize: 11,
                    headerBgColor: '#3498db',
                    headerTextColor: '#ffffff',
                    dataTextColor: '#2c3e50',
                    alternateRowColor: '#f8f9fa',
                    borderColor: '#e9ecef',
                    gridLines: 'horizontal',
                    textAlignment: 'left'
                },
                elegant: {
                    headerFont: 'Georgia',
                    headerSize: 14,
                    dataFont: 'Times New Roman',
                    dataSize: 12,
                    headerBgColor: '#9b59b6',
                    headerTextColor: '#ffffff',
                    dataTextColor: '#2c3e50',
                    alternateRowColor: '#f8f9fa',
                    borderColor: '#d5a6bd',
                    gridLines: 'all',
                    textAlignment: 'center'
                },
                minimal: {
                    headerFont: 'Arial',
                    headerSize: 11,
                    dataFont: 'Arial',
                    dataSize: 10,
                    headerBgColor: '#34495e',
                    headerTextColor: '#ffffff',
                    dataTextColor: '#2c3e50',
                    alternateRowColor: '#ffffff',
                    borderColor: '#ecf0f1',
                    gridLines: 'none',
                    textAlignment: 'left'
                },
                colorful: {
                    headerFont: 'Verdana',
                    headerSize: 13,
                    dataFont: 'Arial',
                    dataSize: 11,
                    headerBgColor: '#ff6b6b',
                    headerTextColor: '#ffffff',
                    dataTextColor: '#2c3e50',
                    alternateRowColor: '#ffeaa7',
                    borderColor: '#fd79a8',
                    gridLines: 'all',
                    textAlignment: 'center'
                },
                dark: {
                    headerFont: 'Arial',
                    headerSize: 12,
                    dataFont: 'Arial',
                    dataSize: 11,
                    headerBgColor: '#2c3e50',
                    headerTextColor: '#ffffff',
                    dataTextColor: '#ecf0f1',
                    alternateRowColor: '#34495e',
                    borderColor: '#7f8c8d',
                    gridLines: 'all',
                    textAlignment: 'left'
                }
            };
            
            const theme = themes[themeName];
            if (theme) {
                // Apply theme settings with animation
                Object.keys(theme).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = theme[key];
                        // Add animation effect
                        element.style.transform = 'scale(1.05)';
                        element.style.boxShadow = '0 0 10px rgba(72, 149, 239, 0.3)';
                        setTimeout(() => {
                            element.style.transform = 'scale(1)';
                            element.style.boxShadow = '';
                        }, 300);
                    }
                });
                
                // Show success message
                addBotMessage(`🎨 Applied ${themeName.charAt(0).toUpperCase() + themeName.slice(1)} theme!`);
            }
        }
        
        // Enhanced Excel Settings Management
        function updateExcelSettings() {
            try {
                excelSettings = {
                    headerFont: document.getElementById('headerFont')?.value || 'Arial',
                    headerSize: parseInt(document.getElementById('headerSize')?.value || '12'),
                    headerStyle: document.getElementById('headerStyle')?.value || 'normal',
                    dataFont: document.getElementById('dataFont')?.value || 'Calibri',
                    dataSize: parseInt(document.getElementById('dataSize')?.value || '11'),
                    dataStyle: document.getElementById('dataStyle')?.value || 'normal',
                    headerBgColor: document.getElementById('headerBgColor')?.value || '#4361ee',
                    headerTextColor: document.getElementById('headerTextColor')?.value || '#ffffff',
                    dataTextColor: document.getElementById('dataTextColor')?.value || '#000000',
                    alternateRowColor: document.getElementById('alternateRowColor')?.value || '#f8f9fa',
                    borderColor: document.getElementById('borderColor')?.value || '#e0e0e0',
                    gridLines: document.getElementById('gridLines')?.value || 'all',
                    autoFitColumns: document.getElementById('autoFitColumns')?.checked || true,
                    freezeHeader: document.getElementById('freezeHeader')?.checked || true,
                    addFilters: document.getElementById('addFilters')?.checked || true,
                    rowHeight: parseInt(document.getElementById('rowHeight')?.value || '20'),
                    columnWidth: parseInt(document.getElementById('columnWidth')?.value || '15'),
                    textAlignment: document.getElementById('textAlignment')?.value || 'left',
                    wrapText: document.getElementById('wrapText')?.checked || false,
                    sheetName: document.getElementById('sheetName')?.value || 'Data',
                    includeSummary: document.getElementById('includeSummary')?.checked || true,
                    includeCharts: document.getElementById('includeCharts')?.checked || false,
                    protectSheet: document.getElementById('protectSheet')?.checked || false,
                    pageOrientation: document.getElementById('pageOrientation')?.value || 'portrait',
                    pageMargins: parseFloat(document.getElementById('pageMargins')?.value || '0.75'),
                    numberFormat: document.getElementById('numberFormat')?.value || 'general',
                    decimalPlaces: parseInt(document.getElementById('decimalPlaces')?.value || '2'),
                    conditionalFormatting: document.getElementById('conditionalFormatting')?.checked || false,
                    dataValidation: document.getElementById('dataValidation')?.checked || false,
                    autoCalculateTotals: document.getElementById('autoCalculateTotals')?.checked || true,
                    includeTimestamp: document.getElementById('includeTimestamp')?.checked || true
                };
                
                // Save settings to localStorage for persistence
                localStorage.setItem('excelSettings', JSON.stringify(excelSettings));
                
                console.log('Excel settings updated:', excelSettings);
                
                // Show visual feedback for important changes
                const feedbackElement = document.getElementById('excelSettingsFeedback');
                if (!feedbackElement) {
                    const feedback = document.createElement('div');
                    feedback.id = 'excelSettingsFeedback';
                    feedback.style.cssText = `
                        position: fixed; top: 20px; right: 20px; 
                        background: var(--primary); color: white; 
                        padding: 10px 15px; border-radius: 8px; 
                        z-index: 1000; font-size: 0.9em;
                        animation: slideInRight 0.3s ease-out;
                    `;
                    document.body.appendChild(feedback);
                }
                
                const feedback = document.getElementById('excelSettingsFeedback');
                feedback.textContent = '⚙️ Settings updated';
                feedback.style.display = 'block';
                
                setTimeout(() => {
                    feedback.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.warn('Error updating Excel settings:', error);
            }
        }
        
        // Load saved Excel settings
        function loadExcelSettings() {
            try {
                const savedSettings = localStorage.getItem('excelSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    Object.keys(settings).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = settings[key];
                            } else {
                                element.value = settings[key];
                            }
                        }
                    });
                    excelSettings = settings;
                }
            } catch (error) {
                console.warn('Error loading Excel settings:', error);
            }
        }

        // Add event listeners for real-time settings updates
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved Excel settings
            loadExcelSettings();
            
            // Add event listeners for all Excel customization elements
            const settingElements = document.querySelectorAll('.excel-customization input, .excel-customization select');
            settingElements.forEach(element => {
                element.addEventListener('change', updateExcelSettings);
                element.addEventListener('input', updateExcelSettings);
            });
            
            // Initialize Excel settings
            updateExcelSettings();
        });

        // Add after processPdfFile and before displayResults
        async function processImageFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const imageData = e.target.result;
                        addBotMessage('🔎 Running OCR on image, please wait...');
                        const result = await Tesseract.recognize(imageData, 'eng', {
                            logger: m => {}
                        });
                        const text = result.data.text;
                        // Optionally: AI table detection
                        // const tableData = await detectTablesWithAI(imageData);
                        // if (tableData) { resolve(tableData); return; }
                        const structuredData = extractStructuredContent(text);
                        resolve({
                            headers: structuredData.headers,
                            rows: structuredData.rows
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // AI Table Detection stub (to be expanded with a real model)
        async function detectTablesWithAI(imageData) {
            // Placeholder: Use TensorFlow.js to run a table detection model
            // For now, just return null
            // In production, load a model and run prediction on imageData
            return null;
        }

        // --- Firebase Initialization ---
        // Replace with your Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyAVQBxs6OFbn9GmIy_RdUDVfYUSzBxRuMU",
          authDomain: "seif-7f369.firebaseapp.com",
          projectId: "seif-7f369",
          storageBucket: "seif-7f369.appspot.com", // <-- fixed typo
          messagingSenderId: "422769131969",
          appId: "1:422769131969:web:7d267f1f74a894c23f6f40",
          measurementId: "G-0P58R2DW2G"
        };

        // Helper to check if config is set
        function isFirebaseConfigValid(config) {
            return config.apiKey && !config.apiKey.includes('YOUR_API_KEY') &&
                   config.projectId && !config.projectId.includes('YOUR_PROJECT_ID') &&
                   config.storageBucket && !config.storageBucket.includes('YOUR_PROJECT_ID');
        }

        if (!isFirebaseConfigValid(firebaseConfig)) {
            console.warn('Firebase config is missing or invalid. Please set your Firebase credentials.');
            window.firebaseConfigError = true;
        } else {
            firebase.initializeApp(firebaseConfig);
            window.firebaseConfigError = false;
        }
        const db = window.firebaseConfigError ? null : firebase.firestore();
        const storage = window.firebaseConfigError ? null : firebase.storage();

        // --- Real-Time Collaboration ---
        let sessionId = null;
        let unsubscribeCollab = null;

        document.getElementById('collaborateBtn').addEventListener('click', async () => {
            if (!convertedData) {
                addBotMessage('Please convert a file first.');
                return;
            }
            sessionId = prompt('Enter a session name to collaborate (or leave blank for a random one):') || Math.random().toString(36).substring(2, 10);
            addBotMessage(`🔗 Collaboration session: <b>${sessionId}</b>. Share this session name with others to join.`);
            // Save current data
            await db.collection('sessions').doc(sessionId).set({ tableData: convertedData });
            // Listen for changes
            if (unsubscribeCollab) unsubscribeCollab();
            unsubscribeCollab = db.collection('sessions').doc(sessionId).onSnapshot(doc => {
                if (doc.exists && JSON.stringify(convertedData) !== JSON.stringify(doc.data().tableData)) {
                    convertedData = doc.data().tableData;
                    displayResults(convertedData);
                    addBotMessage('🔄 Table updated from collaboration session.');
                }
            });
        });
        // When user edits data, push to Firestore if in session
        function pushCollabUpdate() {
            if (sessionId) {
                db.collection('sessions').doc(sessionId).set({ tableData: convertedData });
            }
        }
        // Call pushCollabUpdate() after any data edit (add, update, delete, etc.)
        // Example: after displayResults(convertedData), call pushCollabUpdate();
        // ... you can add this call in your data editing functions ...

        // --- Database Direct Export (Airtable Example) ---
        document.getElementById('exportDbBtn').addEventListener('click', async () => {
            if (!convertedData) {
                addBotMessage('Please convert a file first.');
                return;
            }
            const apiKey = prompt('Enter your Airtable API Key:');
            const baseId = prompt('Enter your Airtable Base ID:');
            const tableName = prompt('Enter your Airtable Table Name:');
            if (!apiKey || !baseId || !tableName) {
                addBotMessage('❌ Missing Airtable credentials.');
                return;
            }
            for (const row of convertedData.rows) {
                await fetch(`https://api.airtable.com/v0/${baseId}/${tableName}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fields: row })
                });
            }
            addBotMessage('✅ Exported to Airtable!');
        });

        // Preview Excel Settings Function
        function previewExcelSettings() {
            // Get current settings
            updateExcelSettings();
            
            // Create a preview table with current settings
            const previewData = {
                headers: ['Preview Column 1', 'Preview Column 2', 'Preview Column 3'],
                rows: [
                    { 'Preview Column 1': 'Sample Data 1', 'Preview Column 2': 'Sample Data 2', 'Preview Column 3': 'Sample Data 3' },
                    { 'Preview Column 1': 'Sample Data 4', 'Preview Column 2': 'Sample Data 5', 'Preview Column 3': 'Sample Data 6' },
                    { 'Preview Column 1': 'Sample Data 7', 'Preview Column 2': 'Sample Data 8', 'Preview Column 3': 'Sample Data 9' }
                ]
            };
            
            // Create preview modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 12px; padding: 30px;
                max-width: 800px; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--primary); margin: 0;">🎨 Excel Settings Preview</h3>
                    <button onclick="this.closest('.preview-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);">Current Settings:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                        <div><strong>Header Font:</strong> ${excelSettings.headerFont}</div>
                        <div><strong>Header Size:</strong> ${excelSettings.headerSize}px</div>
                        <div><strong>Header Color:</strong> <span style="color: ${excelSettings.headerBgColor};">${excelSettings.headerBgColor}</span></div>
                        <div><strong>Data Font:</strong> ${excelSettings.dataFont}</div>
                        <div><strong>Grid Lines:</strong> ${excelSettings.gridLines}</div>
                        <div><strong>Row Height:</strong> ${excelSettings.rowHeight}px</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);">Preview Table:</h4>
                    <div id="previewTable" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;"></div>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="this.closest('.preview-modal').remove()" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Close Preview
                    </button>
                </div>
            `;
            
            modal.className = 'preview-modal';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Create preview table with current settings
            const previewTable = document.getElementById('previewTable');
            const table = document.createElement('table');
            table.style.cssText = `
                width: 100%; border-collapse: collapse; font-family: ${excelSettings.dataFont}, sans-serif;
            `;
            
            // Create header row
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            previewData.headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                th.style.cssText = `
                    background: ${excelSettings.headerBgColor}; 
                    color: ${excelSettings.headerTextColor}; 
                    padding: 12px; 
                    text-align: ${excelSettings.textAlignment}; 
                    font-weight: ${excelSettings.headerStyle.includes('bold') ? 'bold' : 'normal'};
                    font-style: ${excelSettings.headerStyle.includes('italic') ? 'italic' : 'normal'};
                    font-size: ${excelSettings.headerSize}px;
                    border: ${excelSettings.gridLines !== 'none' ? `1px solid ${excelSettings.borderColor}` : 'none'};
                `;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create data rows
            const tbody = document.createElement('tbody');
            previewData.rows.forEach((row, index) => {
                const tr = document.createElement('tr');
                previewData.headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    td.style.cssText = `
                        padding: 8px 12px; 
                        text-align: ${excelSettings.textAlignment}; 
                        font-size: ${excelSettings.dataSize}px;
                        font-weight: ${excelSettings.dataStyle.includes('bold') ? 'bold' : 'normal'};
                        font-style: ${excelSettings.dataStyle.includes('italic') ? 'italic' : 'normal'};
                        color: ${excelSettings.dataTextColor};
                        background: ${index % 2 === 0 && excelSettings.alternateRowColor !== '#ffffff' ? excelSettings.alternateRowColor : 'white'};
                        border: ${excelSettings.gridLines !== 'none' ? `1px solid ${excelSettings.borderColor}` : 'none'};
                    `;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            
            previewTable.appendChild(table);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Test function to verify Excel styling is working
        function testExcelStyling() {
            addBotMessage('🧪 Testing Excel styling...');
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                ['Test Header 1', 'Test Header 2', 'Test Header 3'],
                ['Data 1', 'Data 2', 'Data 3'],
                ['Data 4', 'Data 5', 'Data 6']
            ]);
            
            // Apply obvious styling to test
            ws['A1'].s = {
                font: { bold: true, color: { rgb: "FF0000" }, sz: 16 },
                fill: { fgColor: { rgb: "FFFF00" } },
                alignment: { horizontal: "center" },
                border: { 
                    top: { style: "thick", color: { rgb: "0000FF" } },
                    bottom: { style: "thick", color: { rgb: "0000FF" } },
                    left: { style: "thick", color: { rgb: "0000FF" } },
                    right: { style: "thick", color: { rgb: "0000FF" } }
                }
            };
            
            ws['B1'].s = {
                font: { bold: true, color: { rgb: "FF0000" }, sz: 16 },
                fill: { fgColor: { rgb: "FFFF00" } },
                alignment: { horizontal: "center" },
                border: { 
                    top: { style: "thick", color: { rgb: "0000FF" } },
                    bottom: { style: "thick", color: { rgb: "0000FF" } },
                    left: { style: "thick", color: { rgb: "0000FF" } },
                    right: { style: "thick", color: { rgb: "0000FF" } }
                }
            };
            
            ws['C1'].s = {
                font: { bold: true, color: { rgb: "FF0000" }, sz: 16 },
                fill: { fgColor: { rgb: "FFFF00" } },
                alignment: { horizontal: "center" },
                border: { 
                    top: { style: "thick", color: { rgb: "0000FF" } },
                    bottom: { style: "thick", color: { rgb: "0000FF" } },
                    left: { style: "thick", color: { rgb: "0000FF" } },
                    right: { style: "thick", color: { rgb: "0000FF" } }
                }
            };
            
            // Style data cells
            for (let row = 2; row <= 3; row++) {
                for (let col = 0; col < 3; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row - 1, c: col });
                    ws[cellAddress].s = {
                        font: { color: { rgb: "00FF00" }, sz: 12 },
                        fill: { fgColor: { rgb: "FFE6E6" } },
                        border: { 
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        }
                    };
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, 'Test');
            
            const wopts = {
                bookType: 'xlsx',
                bookSST: false,
                type: 'binary',
                cellStyles: true
            };
            
            XLSX.writeFile(wb, 'test_styling.xlsx', wopts);
            addBotMessage('✅ Test file "test_styling.xlsx" created! If you see red bold text on yellow background with blue borders, styling is working.');
        }

        // Simple fallback Excel export function
        function simpleExportToExcel() {
            console.log('Simple Excel export called');
            
            if (!convertedData) {
                addBotMessage('❌ No data to export. Please convert a file first.');
                return;
            }
            
            try {
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Convert data to array format
                const excelData = [convertedData.headers];
                convertedData.rows.forEach(row => {
                    const rowData = convertedData.headers.map(header => row[header] || '');
                    excelData.push(rowData);
                });
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Add to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Data');
                
                // Generate filename
                let filename = 'SmartDoc_Export.xlsx';
                if (selectedFiles.length > 0) {
                    const originalFileName = selectedFiles[0].name;
                    const nameWithoutExt = originalFileName.replace(/\.[^/.]+$/, "");
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    filename = `${nameWithoutExt}_converted_${timestamp}.xlsx`;
                }
                
                // Write file
                XLSX.writeFile(wb, filename);
                
                addBotMessage(`✅ Excel file "${filename}" downloaded successfully! (Simple export)`);
                
            } catch (error) {
                console.error('Error in simple export:', error);
                addBotMessage(`❌ Error in simple export: ${error.message}`);
            }
        }

        // Test export function to debug issues
        function testExport() {
            console.log('=== TEST EXPORT START ===');
            console.log('convertedData exists:', !!convertedData);
            console.log('XLSX exists:', typeof XLSX !== 'undefined');
            console.log('exportToExcel function exists:', typeof exportToExcel === 'function');
            
            if (!convertedData) {
                addBotMessage('❌ No data available for test export');
                return;
            }
            
            console.log('Data summary:');
            console.log('- Headers:', convertedData.headers);
            console.log('- Total rows:', convertedData.rows.length);
            console.log('- First row:', convertedData.rows[0]);
            console.log('- Last row:', convertedData.rows[convertedData.rows.length - 1]);
            
            addBotMessage(`🧪 Test: Found ${convertedData.rows.length} rows with ${convertedData.headers.length} columns`);
            
            // Check data integrity
            let dataIssues = [];
            convertedData.rows.forEach((row, index) => {
                if (!row || typeof row !== 'object') {
                    dataIssues.push(`Row ${index}: Not an object`);
                } else {
                    convertedData.headers.forEach(header => {
                        if (!(header in row)) {
                            dataIssues.push(`Row ${index}: Missing header "${header}"`);
                        }
                    });
                }
            });
            
            if (dataIssues.length > 0) {
                console.warn('Data integrity issues found:', dataIssues.slice(0, 10));
                addBotMessage(`⚠️ Found ${dataIssues.length} data integrity issues. Check console for details.`);
            } else {
                addBotMessage('✅ Data structure looks good!');
            }
            
            // Try to create a simple test file
            try {
                const wb = XLSX.utils.book_new();
                const testData = [
                    ['Test Header 1', 'Test Header 2'],
                    ['Test Data 1', 'Test Data 2'],
                    ['Test Data 3', 'Test Data 4']
                ];
                const ws = XLSX.utils.aoa_to_sheet(testData);
                XLSX.utils.book_append_sheet(wb, ws, 'Test');
                XLSX.writeFile(wb, 'test_export.xlsx');
                addBotMessage('✅ Test export successful! Check for test_export.xlsx file.');
            } catch (error) {
                console.error('Test export failed:', error);
                addBotMessage(`❌ Test export failed: ${error.message}`);
            }
            
            console.log('=== TEST EXPORT END ===');
        }

        // Function to verify data processing
        function verifyDataProcessing() {
            if (!convertedData) {
                addBotMessage('❌ No data to verify');
                return;
            }
            
            console.log('=== DATA VERIFICATION START ===');
            
            // Check basic structure
            console.log('Headers count:', convertedData.headers.length);
            console.log('Rows count:', convertedData.rows.length);
            
            // Check for empty or null data
            let emptyRows = 0;
            let nullValues = 0;
            let totalValues = 0;
            
            convertedData.rows.forEach((row, rowIndex) => {
                let rowEmpty = true;
                convertedData.headers.forEach(header => {
                    totalValues++;
                    const value = row[header];
                    if (value === null || value === undefined || value === '') {
                        nullValues++;
                    } else {
                        rowEmpty = false;
                    }
                });
                if (rowEmpty) emptyRows++;
            });
            
            console.log('Data statistics:');
            console.log('- Empty rows:', emptyRows);
            console.log('- Null/empty values:', nullValues);
            console.log('- Total values:', totalValues);
            console.log('- Data completeness:', ((totalValues - nullValues) / totalValues * 100).toFixed(2) + '%');
            
            addBotMessage(`📊 Data verification: ${convertedData.rows.length} rows, ${convertedData.headers.length} columns, ${((totalValues - nullValues) / totalValues * 100).toFixed(2)}% complete data`);
            
            // Check for potential export issues
            if (convertedData.rows.length > 10000) {
                addBotMessage('⚠️ Large dataset detected. Export may take time.');
            }
            
            if (nullValues > totalValues * 0.5) {
                addBotMessage('⚠️ High number of empty values detected.');
            }
            
            console.log('=== DATA VERIFICATION END ===');
        }
        
        // Editing Mode Variables
        let editingData = null;
        let selectedCell = null;
        let clipboardData = null;
        let cellFormats = {};
        
        // Enter Editing Mode
        function enterEditingMode() {
            if (!convertedData) {
                addBotMessage('❌ No data to edit. Please convert a file first.');
                return;
            }
            
            // Hide results section and show editing mode
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('editingMode').style.display = 'block';
            
            // Create a deep copy of the data for editing
            editingData = JSON.parse(JSON.stringify(convertedData));
            
            // Generate spreadsheet
            generateSpreadsheet();
            
            addBotMessage('✅ Entered editing mode! You can now edit your data directly in the spreadsheet.');
        }
        
        // Exit Editing Mode
        function exitEditingMode() {
            document.getElementById('editingMode').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            // Update the main data with edited data
            if (editingData) {
                convertedData = editingData;
                displayResults(convertedData);
            }
            
            addBotMessage('✅ Exited editing mode. Your changes have been saved.');
        }
        
        // Generate Spreadsheet
        function generateSpreadsheet() {
            const grid = document.getElementById('spreadsheetGrid');
            grid.innerHTML = '';
            
            const table = document.createElement('table');
            table.className = 'spreadsheet-table';
            
            // Create header row
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // Add empty cell for row headers
            const emptyHeader = document.createElement('th');
            emptyHeader.textContent = '';
            headerRow.appendChild(emptyHeader);
            
            // Add column headers
            editingData.headers.forEach((header, index) => {
                const th = document.createElement('th');
                th.textContent = String.fromCharCode(65 + index); // A, B, C, etc.
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create data rows
            const tbody = document.createElement('tbody');
            
            editingData.rows.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                
                // Add row header
                const rowHeader = document.createElement('th');
                rowHeader.textContent = rowIndex + 1;
                tr.appendChild(rowHeader);
                
                // Add data cells
                editingData.headers.forEach((header, colIndex) => {
                    const td = document.createElement('td');
                    td.dataset.row = rowIndex;
                    td.dataset.col = colIndex;
                    td.dataset.address = `${String.fromCharCode(65 + colIndex)}${rowIndex + 1}`;
                    
                    const input = document.createElement('input');
                    input.className = 'spreadsheet-cell';
                    input.type = 'text';
                    input.value = row[header] || '';
                    input.dataset.header = header;
                    
                    // Add event listeners
                    input.addEventListener('focus', () => selectCell(td, input));
                    input.addEventListener('blur', () => updateCellData(td, input));
                    input.addEventListener('keydown', (e) => handleCellKeydown(e, td, input));
                    
                    td.appendChild(input);
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            grid.appendChild(table);
            
            // Initialize cell formats
            initializeCellFormats();
        }
        
        // Initialize Cell Formats
        function initializeCellFormats() {
            cellFormats = {};
            // Set default formats for all cells
            editingData.rows.forEach((row, rowIndex) => {
                editingData.headers.forEach((header, colIndex) => {
                    const address = `${String.fromCharCode(65 + colIndex)}${rowIndex + 1}`;
                    cellFormats[address] = {
                        fontFamily: 'Calibri',
                        fontSize: 11,
                        bold: false,
                        italic: false,
                        underline: false,
                        textColor: '#000000',
                        bgColor: '#ffffff',
                        alignment: 'left',
                        verticalAlignment: 'middle',
                        borders: {}
                    };
                });
            });
        }
        
        // Select Cell
        function selectCell(td, input) {
            // Remove previous selection
            document.querySelectorAll('.cell-selected').forEach(cell => {
                cell.classList.remove('cell-selected');
            });
            
            // Select current cell
            td.classList.add('cell-selected');
            selectedCell = { td, input, address: td.dataset.address };
            
            // Update cell info
            document.getElementById('cellAddress').textContent = td.dataset.address;
            document.getElementById('cellValue').textContent = input.value;
            document.getElementById('formulaBar').value = input.value;
            
            // Update formatting controls
            updateFormattingControls();
        }
        
        // Update Cell Data
        function updateCellData(td, input) {
            const rowIndex = parseInt(td.dataset.row);
            const header = input.dataset.header;
            const newValue = input.value;
            
            editingData.rows[rowIndex][header] = newValue;
        }
        
        // Handle Cell Keydown
        function handleCellKeydown(e, td, input) {
            const currentRow = parseInt(td.dataset.row);
            const currentCol = parseInt(td.dataset.col);
            
            switch (e.key) {
                case 'Enter':
                    e.preventDefault();
                    navigateCell(currentRow + 1, currentCol);
                    break;
                case 'Tab':
                    e.preventDefault();
                    if (e.shiftKey) {
                        navigateCell(currentRow, currentCol - 1);
                    } else {
                        navigateCell(currentRow, currentCol + 1);
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    navigateCell(currentRow - 1, currentCol);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    navigateCell(currentRow + 1, currentCol);
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    navigateCell(currentRow, currentCol - 1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    navigateCell(currentRow, currentCol + 1);
                    break;
            }
        }
        
        // Navigate to Cell
        function navigateCell(row, col) {
            if (row < 0 || row >= editingData.rows.length || col < 0 || col >= editingData.headers.length) {
                return;
            }
            
            const targetTd = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
            if (targetTd) {
                const input = targetTd.querySelector('.spreadsheet-cell');
                input.focus();
            }
        }
        
        // Update Formatting Controls
        function updateFormattingControls() {
            if (!selectedCell) return;
            
            const format = cellFormats[selectedCell.address] || {};
            
            // Update font controls
            document.getElementById('editFontFamily').value = format.fontFamily || 'Calibri';
            document.getElementById('editFontSize').value = format.fontSize || 11;
            document.getElementById('editTextColor').value = format.textColor || '#000000';
            document.getElementById('editBgColor').value = format.bgColor || '#ffffff';
            
            // Update style buttons
            document.getElementById('boldBtn').classList.toggle('active', format.bold);
            document.getElementById('italicBtn').classList.toggle('active', format.italic);
            document.getElementById('underlineBtn').classList.toggle('active', format.underline);
            
            // Update alignment buttons
            document.getElementById('alignLeftBtn').classList.toggle('active', format.alignment === 'left');
            document.getElementById('alignCenterBtn').classList.toggle('active', format.alignment === 'center');
            document.getElementById('alignRightBtn').classList.toggle('active', format.alignment === 'right');
            
            document.getElementById('valignTopBtn').classList.toggle('active', format.verticalAlignment === 'top');
            document.getElementById('valignMiddleBtn').classList.toggle('active', format.verticalAlignment === 'middle');
            document.getElementById('valignBottomBtn').classList.toggle('active', format.verticalAlignment === 'bottom');
        }
        
        // Apply Cell Format
        function applyCellFormat(property) {
            if (!selectedCell) return;
            
            const address = selectedCell.address;
            if (!cellFormats[address]) {
                cellFormats[address] = {};
            }
            
            switch (property) {
                case 'fontFamily':
                    cellFormats[address].fontFamily = document.getElementById('editFontFamily').value;
                    break;
                case 'fontSize':
                    cellFormats[address].fontSize = parseInt(document.getElementById('editFontSize').value);
                    break;
                case 'textColor':
                    cellFormats[address].textColor = document.getElementById('editTextColor').value;
                    break;
                case 'bgColor':
                    cellFormats[address].bgColor = document.getElementById('editBgColor').value;
                    break;
            }
            
            applyFormatToCell(selectedCell.td, cellFormats[address]);
        }
        
        // Toggle Format
        function toggleFormat(format) {
            if (!selectedCell) return;
            
            const address = selectedCell.address;
            if (!cellFormats[address]) {
                cellFormats[address] = {};
            }
            
            cellFormats[address][format] = !cellFormats[address][format];
            applyFormatToCell(selectedCell.td, cellFormats[address]);
            updateFormattingControls();
        }
        
        // Set Alignment
        function setAlignment(alignment) {
            if (!selectedCell) return;
            
            const address = selectedCell.address;
            if (!cellFormats[address]) {
                cellFormats[address] = {};
            }
            
            cellFormats[address].alignment = alignment;
            applyFormatToCell(selectedCell.td, cellFormats[address]);
            updateFormattingControls();
        }
        
        // Set Vertical Alignment
        function setVerticalAlignment(alignment) {
            if (!selectedCell) return;
            
            const address = selectedCell.address;
            if (!cellFormats[address]) {
                cellFormats[address] = {};
            }
            
            cellFormats[address].verticalAlignment = alignment;
            applyFormatToCell(selectedCell.td, cellFormats[address]);
            updateFormattingControls();
        }
        
        // Apply Format to Cell
        function applyFormatToCell(td, format) {
            const input = td.querySelector('.spreadsheet-cell');
            
            input.style.fontFamily = format.fontFamily || 'Calibri';
            input.style.fontSize = (format.fontSize || 11) + 'px';
            input.style.fontWeight = format.bold ? 'bold' : 'normal';
            input.style.fontStyle = format.italic ? 'italic' : 'normal';
            input.style.textDecoration = format.underline ? 'underline' : 'none';
            input.style.color = format.textColor || '#000000';
            td.style.backgroundColor = format.bgColor || '#ffffff';
            input.style.textAlign = format.alignment || 'left';
            td.style.verticalAlign = format.verticalAlignment || 'middle';
        }
        
        // Border Functions
        function applyBorder() {
            if (!selectedCell) return;
            
            const address = selectedCell.address;
            if (!cellFormats[address]) {
                cellFormats[address] = {};
            }
            if (!cellFormats[address].borders) {
                cellFormats[address].borders = {};
            }
            
            const style = document.getElementById('editBorderStyle').value;
            const color = document.getElementById('editBorderColor').value;
            
            // Apply to all active borders
            Object.keys(cellFormats[address].borders).forEach(position => {
                if (cellFormats[address].borders[position]) {
                    cellFormats[address].borders[position] = { style, color };
                }
            });
            
            applyBordersToCell(selectedCell.td, cellFormats[address].borders);
        }
        
        function toggleBorder(position) {
            if (!selectedCell) return;
            
            const address = selectedCell.address;
            if (!cellFormats[address]) {
                cellFormats[address] = {};
            }
            if (!cellFormats[address].borders) {
                cellFormats[address].borders = {};
            }
            
            const style = document.getElementById('editBorderStyle').value;
            const color = document.getElementById('editBorderColor').value;
            
            if (cellFormats[address].borders[position]) {
                delete cellFormats[address].borders[position];
            } else {
                cellFormats[address].borders[position] = { style, color };
            }
            
            applyBordersToCell(selectedCell.td, cellFormats[address].borders);
            
            // Update border button states
            document.getElementById(`border${position.charAt(0).toUpperCase() + position.slice(1)}Btn`).classList.toggle('active', !!cellFormats[address].borders[position]);
        }
        
        function applyBordersToCell(td, borders) {
            // Reset all borders
            td.style.borderTop = '1px solid #e0e0e0';
            td.style.borderBottom = '1px solid #e0e0e0';
            td.style.borderLeft = '1px solid #e0e0e0';
            td.style.borderRight = '1px solid #e0e0e0';
            
            // Apply custom borders
            Object.keys(borders).forEach(position => {
                const border = borders[position];
                const borderStyle = `${border.style} solid ${border.color}`;
                
                switch (position) {
                    case 'top':
                        td.style.borderTop = borderStyle;
                        break;
                    case 'bottom':
                        td.style.borderBottom = borderStyle;
                        break;
                    case 'left':
                        td.style.borderLeft = borderStyle;
                        break;
                    case 'right':
                        td.style.borderRight = borderStyle;
                        break;
                }
            });
        }
        
        // Table Operations
        function addRow() {
            const newRow = {};
            editingData.headers.forEach(header => {
                newRow[header] = '';
            });
            editingData.rows.push(newRow);
            generateSpreadsheet();
            addBotMessage('✅ Row added successfully!');
        }
        
        function addColumn() {
            const columnName = prompt('Enter column name:');
            if (columnName) {
                editingData.headers.push(columnName);
                editingData.rows.forEach(row => {
                    row[columnName] = '';
                });
                generateSpreadsheet();
                addBotMessage(`✅ Column "${columnName}" added successfully!`);
            }
        }
        
        function deleteRow() {
            if (!selectedCell) {
                addBotMessage('❌ Please select a cell in the row you want to delete.');
                return;
            }
            
            const rowIndex = parseInt(selectedCell.td.dataset.row);
            if (confirm(`Are you sure you want to delete row ${rowIndex + 1}?`)) {
                editingData.rows.splice(rowIndex, 1);
                generateSpreadsheet();
                addBotMessage(`✅ Row ${rowIndex + 1} deleted successfully!`);
            }
        }
        
        function deleteColumn() {
            if (!selectedCell) {
                addBotMessage('❌ Please select a cell in the column you want to delete.');
                return;
            }
            
            const colIndex = parseInt(selectedCell.td.dataset.col);
            const columnName = editingData.headers[colIndex];
            
            if (confirm(`Are you sure you want to delete column "${columnName}"?`)) {
                editingData.headers.splice(colIndex, 1);
                editingData.rows.forEach(row => {
                    delete row[columnName];
                });
                generateSpreadsheet();
                addBotMessage(`✅ Column "${columnName}" deleted successfully!`);
            }
        }
        
        // Quick Actions
        function autoFitColumns() {
            const table = document.querySelector('.spreadsheet-table');
            const cells = table.querySelectorAll('td');
            
            cells.forEach(cell => {
                const input = cell.querySelector('.spreadsheet-cell');
                const textWidth = input.value.length * 8; // Approximate character width
                cell.style.minWidth = Math.max(100, textWidth + 20) + 'px';
            });
            
            addBotMessage('✅ Columns auto-fitted!');
        }
        
        function clearFormatting() {
            if (!selectedCell) {
                addBotMessage('❌ Please select a cell to clear formatting.');
                return;
            }
            
            const address = selectedCell.address;
            delete cellFormats[address];
            
            const input = selectedCell.td.querySelector('.spreadsheet-cell');
            input.style = '';
            selectedCell.td.style = '';
            
            updateFormattingControls();
            addBotMessage('✅ Formatting cleared!');
        }
        
        function selectAll() {
            document.querySelectorAll('.spreadsheet-cell').forEach(input => {
                input.select();
            });
            addBotMessage('✅ All cells selected!');
        }
        
        function copySelection() {
            if (!selectedCell) {
                addBotMessage('❌ Please select a cell to copy.');
                return;
            }
            
            clipboardData = selectedCell.input.value;
            addBotMessage('✅ Cell content copied to clipboard!');
        }
        
        function pasteSelection() {
            if (!clipboardData || !selectedCell) {
                addBotMessage('❌ No data to paste or no cell selected.');
                return;
            }
            
            selectedCell.input.value = clipboardData;
            updateCellData(selectedCell.td, selectedCell.input);
            addBotMessage('✅ Content pasted successfully!');
        }
        
        // Formula Functions
        function handleFormulaInput(e) {
            if (e.key === 'Enter') {
                applyFormula();
            }
        }
        
        function applyFormula() {
            if (!selectedCell) {
                addBotMessage('❌ Please select a cell to apply formula.');
                return;
            }
            
            const formula = document.getElementById('formulaBar').value;
            selectedCell.input.value = formula;
            updateCellData(selectedCell.td, selectedCell.input);
            
            document.getElementById('cellValue').textContent = formula;
            addBotMessage('✅ Formula applied!');
        }
        
        // Save and Export Functions
        function saveEdits() {
            if (editingData) {
                convertedData = editingData;
                addBotMessage('✅ Changes saved successfully!');
            }
        }
        
        function exportFromEditor() {
            if (editingData) {
                convertedData = editingData;
                exitEditingMode();
                exportToExcel();
            }
        }
        
        // Language Selector Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const languageSelect = document.getElementById('languageSelect');
            
            // Debug: Check if language selector exists
            console.log('Language selector found:', languageSelect);
            
            if (!languageSelect) {
                console.error('Language selector not found!');
                return;
            }
            
            // Load saved language preference
            const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
            languageSelect.value = savedLanguage;
            console.log('Saved language:', savedLanguage);
            
            // Language translations object
            const translations = {
                en: {
                    title: 'SmartDoc Converter | File to Database/Excel',
                    convertTitle: 'Convert Files to Database/Excel',
                    convertDesc: 'Upload your Word, Excel, or PowerPoint files to convert them into organized databases or Excel files.',
                    dragDrop: 'Drag & Drop Files Here',
                    clickBrowse: 'or click to browse files (supports multiple files)',
                    selectedFiles: 'Selected Files:',
                    outputFormat: 'Output Format:',
                    dataOrganization: 'Data Organization:',
                    namingConvention: 'Naming Convention:',
                    fileProcessing: 'File Processing:',
                    excelWorkbook: 'Excel Workbook (.xlsx)',
                    csvFile: 'CSV File (.csv)',
                    jsonDatabase: 'JSON Database',
                    autoDetect: 'Auto-detect Structure',
                    extractTables: 'Extract Tables Only',
                    extractText: 'Extract All Text',
                    mixedContent: 'Mixed Content',
                    keepOriginal: 'Keep Original Names',
                    snakeCase: 'snake_case',
                    camelCase: 'camelCase',
                    pascalCase: 'PascalCase',
                    processSeparately: 'Process Separately',
                    mergeFiles: 'Merge All Files',
                    splitFiles: 'Split Large Files',
                    convert: 'Convert Files',
                    login: 'Log In',
                    signup: 'Sign Up',
                    darkMode: 'Dark Mode',
                    lightMode: 'Light Mode',
                    excelCustomization: 'Excel Customization',
                    fontSettings: 'Font Settings',
                    headerFont: 'Header Font:',
                    headerSize: 'Header Size:',
                    headerStyle: 'Header Style:',
                    dataFont: 'Data Font:',
                    dataSize: 'Data Size:',
                    dataStyle: 'Data Style:',
                    colorSettings: 'Color Settings',
                    headerBackground: 'Header Background:',
                    headerText: 'Header Text:',
                    dataTextColor: 'Data Text Color:',
                    alternateRowColor: 'Alternate Row Color:',
                    borderColor: 'Border Color:',
                    gridLines: 'Grid Lines:',
                    allBorders: 'All Borders',
                    horizontalOnly: 'Horizontal Only',
                    verticalOnly: 'Vertical Only',
                    noBorders: 'No Borders',
                    layoutSettings: 'Layout Settings',
                    autoFitColumns: 'Auto-fit Columns:',
                    freezeHeaderRow: 'Freeze Header Row:',
                    addFilters: 'Add Filters:',
                    rowHeight: 'Row Height:',
                    columnWidth: 'Column Width:',
                    textAlignment: 'Text Alignment:',
                    left: 'Left',
                    center: 'Center',
                    right: 'Right',
                    justify: 'Justify',
                    wrapText: 'Wrap Text:',
                    sheetSettings: 'Sheet Settings',
                    sheetName: 'Sheet Name:',
                    includeSummarySheet: 'Include Summary Sheet:',
                    includeChartsSheet: 'Include Charts Sheet:',
                    protectSheet: 'Protect Sheet:',
                    pageOrientation: 'Page Orientation:',
                    portrait: 'Portrait',
                    landscape: 'Landscape',
                    margins: 'Margins (inches):',
                    presetThemes: 'Preset Themes',
                    professional: 'Professional',
                    modern: 'Modern',
                    elegant: 'Elegant',
                    minimal: 'Minimal',
                    colorful: 'Colorful',
                    dark: 'Dark',
                    previewSettings: 'Preview Settings',
                    testStyling: 'Test Styling'
                },
                de: {
                    title: 'SmartDoc Converter | Datei zu Datenbank/Excel',
                    convertTitle: 'Dateien zu Datenbank/Excel Konvertieren',
                    convertDesc: 'Laden Sie Ihre Word-, Excel- oder PowerPoint-Dateien hoch, um sie in organisierte Datenbanken oder Excel-Dateien zu konvertieren.',
                    dragDrop: 'Dateien Hier Hineinziehen und Ablegen',
                    clickBrowse: 'oder klicken Sie, um Dateien zu durchsuchen (unterstützt mehrere Dateien)',
                    selectedFiles: 'Ausgewählte Dateien:',
                    outputFormat: 'Ausgabeformat:',
                    dataOrganization: 'Datenorganisation:',
                    namingConvention: 'Namenskonvention:',
                    fileProcessing: 'Dateiverarbeitung:',
                    excelWorkbook: 'Excel-Arbeitsmappe (.xlsx)',
                    csvFile: 'CSV-Datei (.csv)',
                    jsonDatabase: 'JSON-Datenbank',
                    autoDetect: 'Struktur Automatisch Erkennen',
                    extractTables: 'Nur Tabellen Extrahieren',
                    extractText: 'Allen Text Extrahieren',
                    mixedContent: 'Gemischter Inhalt',
                    keepOriginal: 'Ursprüngliche Namen Behalten',
                    snakeCase: 'snake_case',
                    camelCase: 'camelCase',
                    pascalCase: 'PascalCase',
                    processSeparately: 'Separate Verarbeitung',
                    mergeFiles: 'Alle Dateien Zusammenführen',
                    splitFiles: 'Große Dateien Aufteilen',
                    convert: 'Dateien Konvertieren',
                    login: 'Anmelden',
                    signup: 'Registrieren',
                    darkMode: 'Dunkler Modus',
                    lightMode: 'Heller Modus',
                    excelCustomization: 'Excel-Anpassung',
                    fontSettings: 'Schrifteinstellungen',
                    headerFont: 'Kopfzeilen-Schrift:',
                    headerSize: 'Kopfzeilen-Größe:',
                    headerStyle: 'Kopfzeilen-Stil:',
                    dataFont: 'Daten-Schrift:',
                    dataSize: 'Daten-Größe:',
                    dataStyle: 'Daten-Stil:',
                    colorSettings: 'Farbeinstellungen',
                    headerBackground: 'Kopfzeilen-Hintergrund:',
                    headerText: 'Kopfzeilen-Text:',
                    dataTextColor: 'Daten-Textfarbe:',
                    alternateRowColor: 'Alternative Zeilenfarbe:',
                    borderColor: 'Randfarbe:',
                    gridLines: 'Gitternetzlinien:',
                    allBorders: 'Alle Ränder',
                    horizontalOnly: 'Nur Horizontal',
                    verticalOnly: 'Nur Vertikal',
                    noBorders: 'Keine Ränder',
                    layoutSettings: 'Layout-Einstellungen',
                    autoFitColumns: 'Spalten Automatisch Anpassen:',
                    freezeHeaderRow: 'Kopfzeile Fixieren:',
                    addFilters: 'Filter Hinzufügen:',
                    rowHeight: 'Zeilenhöhe:',
                    columnWidth: 'Spaltenbreite:',
                    textAlignment: 'Textausrichtung:',
                    left: 'Links',
                    center: 'Zentriert',
                    right: 'Rechts',
                    justify: 'Blocksatz',
                    wrapText: 'Textumbruch:',
                    sheetSettings: 'Blatteinstellungen',
                    sheetName: 'Blattname:',
                    includeSummarySheet: 'Zusammenfassungsblatt Einfügen:',
                    includeChartsSheet: 'Diagrammblatt Einfügen:',
                    protectSheet: 'Blatt Schützen:',
                    pageOrientation: 'Seitenausrichtung:',
                    portrait: 'Hochformat',
                    landscape: 'Querformat',
                    margins: 'Ränder (Zoll):',
                    presetThemes: 'Vorgefertigte Designs',
                    professional: 'Professionell',
                    modern: 'Modern',
                    elegant: 'Elegant',
                    minimal: 'Minimal',
                    colorful: 'Farbenfroh',
                    dark: 'Dunkel',
                    previewSettings: 'Einstellungen Vorschau',
                    testStyling: 'Stil Testen'
                },
                es: {
                    title: 'SmartDoc Converter | Archivo a Base de Datos/Excel',
                    convertTitle: 'Convertir Archivos a Base de Datos/Excel',
                    convertDesc: 'Sube tus archivos de Word, Excel o PowerPoint para convertirlos en bases de datos organizadas o archivos Excel.',
                    dragDrop: 'Arrastra y Suelta Archivos Aquí',
                    clickBrowse: 'o haz clic para explorar archivos (admite múltiples archivos)',
                    selectedFiles: 'Archivos Seleccionados:',
                    outputFormat: 'Formato de Salida:',
                    dataOrganization: 'Organización de Datos:',
                    namingConvention: 'Convención de Nombres:',
                    fileProcessing: 'Procesamiento de Archivos:',
                    excelWorkbook: 'Libro de Excel (.xlsx)',
                    csvFile: 'Archivo CSV (.csv)',
                    jsonDatabase: 'Base de Datos JSON',
                    autoDetect: 'Detectar Estructura Automáticamente',
                    extractTables: 'Extraer Solo Tablas',
                    extractText: 'Extraer Todo el Texto',
                    mixedContent: 'Contenido Mixto',
                    keepOriginal: 'Mantener Nombres Originales',
                    snakeCase: 'snake_case',
                    camelCase: 'camelCase',
                    pascalCase: 'PascalCase',
                    processSeparately: 'Procesar por Separado',
                    mergeFiles: 'Combinar Todos los Archivos',
                    splitFiles: 'Dividir Archivos Grandes',
                    convert: 'Convertir Archivos',
                    login: 'Iniciar Sesión',
                    signup: 'Registrarse',
                    darkMode: 'Modo Oscuro',
                    lightMode: 'Modo Claro',
                    excelCustomization: 'Personalización de Excel',
                    fontSettings: 'Configuración de Fuente',
                    headerFont: 'Fuente del Encabezado:',
                    headerSize: 'Tamaño del Encabezado:',
                    headerStyle: 'Estilo del Encabezado:',
                    dataFont: 'Fuente de Datos:',
                    dataSize: 'Tamaño de Datos:',
                    dataStyle: 'Estilo de Datos:',
                    colorSettings: 'Configuración de Colores',
                    headerBackground: 'Fondo del Encabezado:',
                    headerText: 'Texto del Encabezado:',
                    dataTextColor: 'Color del Texto de Datos:',
                    alternateRowColor: 'Color de Fila Alterna:',
                    borderColor: 'Color del Borde:',
                    gridLines: 'Líneas de Cuadrícula:',
                    allBorders: 'Todos los Bordes',
                    horizontalOnly: 'Solo Horizontal',
                    verticalOnly: 'Solo Vertical',
                    noBorders: 'Sin Bordes',
                    layoutSettings: 'Configuración de Diseño',
                    autoFitColumns: 'Ajustar Automáticamente Columnas:',
                    freezeHeaderRow: 'Congelar Fila de Encabezado:',
                    addFilters: 'Agregar Filtros:',
                    rowHeight: 'Altura de Fila:',
                    columnWidth: 'Ancho de Columna:',
                    textAlignment: 'Alineación de Texto:',
                    left: 'Izquierda',
                    center: 'Centro',
                    right: 'Derecha',
                    justify: 'Justificar',
                    wrapText: 'Ajustar Texto:',
                    sheetSettings: 'Configuración de Hoja',
                    sheetName: 'Nombre de Hoja:',
                    includeSummarySheet: 'Incluir Hoja de Resumen:',
                    includeChartsSheet: 'Incluir Hoja de Gráficos:',
                    protectSheet: 'Proteger Hoja:',
                    pageOrientation: 'Orientación de Página:',
                    portrait: 'Vertical',
                    landscape: 'Horizontal',
                    margins: 'Márgenes (pulgadas):',
                    presetThemes: 'Temas Preestablecidos',
                    professional: 'Profesional',
                    modern: 'Moderno',
                    elegant: 'Elegante',
                    minimal: 'Minimalista',
                    colorful: 'Colorido',
                    dark: 'Oscuro',
                    previewSettings: 'Vista Previa de Configuración',
                    testStyling: 'Probar Estilo'
                },
                ar: {
                    title: 'سمارت دوك كونفرتر | تحويل الملفات إلى قاعدة بيانات/إكسل',
                    convertTitle: 'تحويل الملفات إلى قاعدة بيانات/إكسل',
                    convertDesc: 'قم بتحميل ملفات وورد أو إكسل أو بوربوينت لتحويلها إلى قواعد بيانات منظمة أو ملفات إكسل.',
                    dragDrop: 'اسحب وأفلت الملفات هنا',
                    clickBrowse: 'أو انقر لتصفح الملفات (يدعم ملفات متعددة)',
                    selectedFiles: 'الملفات المحددة:',
                    outputFormat: 'صيغة الإخراج:',
                    dataOrganization: 'تنظيم البيانات:',
                    namingConvention: 'طريقة التسمية:',
                    fileProcessing: 'معالجة الملفات:',
                    excelWorkbook: 'ملف إكسل (.xlsx)',
                    csvFile: 'ملف CSV (.csv)',
                    jsonDatabase: 'قاعدة بيانات JSON',
                    autoDetect: 'كشف الهيكل تلقائيًا',
                    extractTables: 'استخراج الجداول فقط',
                    extractText: 'استخراج كل النص',
                    mixedContent: 'محتوى مختلط',
                    keepOriginal: 'الاحتفاظ بالأسماء الأصلية',
                    snakeCase: 'حالة الأفعى (snake_case)',
                    camelCase: 'حالة الجمل (camelCase)',
                    pascalCase: 'حالة باسكال (PascalCase)',
                    processSeparately: 'معالجة منفصلة',
                    mergeFiles: 'دمج جميع الملفات',
                    splitFiles: 'تقسيم الملفات الكبيرة',
                    convert: 'تحويل الملفات',
                    login: 'تسجيل الدخول',
                    signup: 'إنشاء حساب',
                    darkMode: 'الوضع الداكن',
                    lightMode: 'الوضع الفاتح',
                    excelCustomization: 'تخصيص إكسل',
                    fontSettings: 'إعدادات الخط',
                    headerFont: 'خط العنوان:',
                    headerSize: 'حجم العنوان:',
                    headerStyle: 'نمط العنوان:',
                    dataFont: 'خط البيانات:',
                    dataSize: 'حجم البيانات:',
                    dataStyle: 'نمط البيانات:',
                    colorSettings: 'إعدادات اللون',
                    headerBackground: 'خلفية العنوان:',
                    headerText: 'نص العنوان:',
                    dataTextColor: 'لون نص البيانات:',
                    alternateRowColor: 'لون صف بديل:',
                    borderColor: 'لون الحدود:',
                    gridLines: 'خطوط الشبكة:',
                    allBorders: 'جميع الحدود',
                    horizontalOnly: 'أفقي فقط',
                    verticalOnly: 'عمودي فقط',
                    noBorders: 'بدون حدود',
                    layoutSettings: 'إعدادات التخطيط',
                    autoFitColumns: 'ضبط تلقائي للأعمدة:',
                    freezeHeaderRow: 'تجميد صف العنوان:',
                    addFilters: 'إضافة فلاتر:',
                    rowHeight: 'ارتفاع الصف:',
                    columnWidth: 'عرض العمود:',
                    textAlignment: 'محاذاة النص:',
                    left: 'يسار',
                    center: 'وسط',
                    right: 'يمين',
                    justify: 'ضبط',
                    wrapText: 'النص بالتفاف:',
                    sheetSettings: 'إعدادات الورقة',
                    sheetName: 'اسم الورقة:',
                    includeSummarySheet: 'تضمين ورقة الملخص:',
                    includeChartsSheet: 'تضمين ورقة الرسوم البيانية:',
                    protectSheet: 'حماية الورقة:',
                    pageOrientation: 'اتجاه الصفحة:',
                    portrait: 'عمودي',
                    landscape: 'أفقي',
                    margins: 'الهوامش (بوصة):',
                    presetThemes: 'السمات المسبقة',
                    professional: 'مهني',
                    modern: 'حديث',
                    elegant: 'أنيق',
                    minimal: 'مبسط',
                    colorful: 'ملون',
                    dark: 'داكن',
                    previewSettings: 'معاينة الإعدادات',
                    testStyling: 'اختبار النمط'
                }
            };
            
            // Function to update page content with selected language
            function updatePageLanguage(language) {
                console.log('Updating language to:', language);
                const lang = translations[language] || translations.en;
                
                // Update page title
                document.title = lang.title;
                console.log('Updated title to:', lang.title);
                
                // Update main content
                const convertTitle = document.querySelector('.upload-section h2');
                if (convertTitle) {
                    convertTitle.textContent = lang.convertTitle;
                    console.log('Updated convert title to:', lang.convertTitle);
                } else {
                    console.warn('Convert title element not found');
                }
                
                const convertDesc = document.querySelector('.upload-section p');
                if (convertDesc) {
                    convertDesc.textContent = lang.convertDesc;
                    console.log('Updated convert description to:', lang.convertDesc);
                } else {
                    console.warn('Convert description element not found');
                }
                
                const dragDrop = document.querySelector('.upload-area h3');
                if (dragDrop) {
                    dragDrop.textContent = lang.dragDrop;
                    console.log('Updated drag drop text to:', lang.dragDrop);
                } else {
                    console.warn('Drag drop element not found');
                }
                
                const clickBrowse = document.querySelector('.upload-area p');
                if (clickBrowse) {
                    clickBrowse.textContent = lang.clickBrowse;
                    console.log('Updated click browse text to:', lang.clickBrowse);
                } else {
                    console.warn('Click browse element not found');
                }
                
                // Update option labels
                const optionLabels = document.querySelectorAll('.option-label');
                console.log('Found option labels:', optionLabels.length);
                if (optionLabels[0]) optionLabels[0].textContent = lang.outputFormat;
                if (optionLabels[1]) optionLabels[1].textContent = lang.dataOrganization;
                if (optionLabels[2]) optionLabels[2].textContent = lang.namingConvention;
                if (optionLabels[3]) optionLabels[3].textContent = lang.fileProcessing;
                
                // Update select options
                const outputFormat = document.getElementById('outputFormat');
                if (outputFormat) {
                    outputFormat.options[0].text = lang.excelWorkbook;
                    outputFormat.options[1].text = lang.csvFile;
                    outputFormat.options[2].text = lang.jsonDatabase;
                    console.log('Updated output format options');
                } else {
                    console.warn('Output format select not found');
                }
                
                const dataOrganization = document.getElementById('dataOrganization');
                if (dataOrganization) {
                    dataOrganization.options[0].text = lang.autoDetect;
                    dataOrganization.options[1].text = lang.extractTables;
                    dataOrganization.options[2].text = lang.extractText;
                    dataOrganization.options[3].text = lang.mixedContent;
                    console.log('Updated data organization options');
                } else {
                    console.warn('Data organization select not found');
                }
                
                const namingConvention = document.getElementById('namingConvention');
                if (namingConvention) {
                    namingConvention.options[0].text = lang.keepOriginal;
                    namingConvention.options[1].text = lang.snakeCase;
                    namingConvention.options[2].text = lang.camelCase;
                    namingConvention.options[3].text = lang.pascalCase;
                    console.log('Updated naming convention options');
                } else {
                    console.warn('Naming convention select not found');
                }
                
                const fileProcessing = document.getElementById('fileProcessing');
                if (fileProcessing) {
                    fileProcessing.options[0].text = lang.processSeparately;
                    fileProcessing.options[1].text = lang.mergeFiles;
                    fileProcessing.options[2].text = lang.splitFiles;
                    console.log('Updated file processing options');
                } else {
                    console.warn('File processing select not found');
                }
                
                // Update buttons
                const convertBtn = document.querySelector('.convert-btn');
                if (convertBtn) {
                    convertBtn.textContent = lang.convert;
                    console.log('Updated convert button to:', lang.convert);
                } else {
                    console.warn('Convert button not found');
                }
                
                const loginBtn = document.querySelector('.login');
                if (loginBtn) {
                    loginBtn.textContent = lang.login;
                    console.log('Updated login button to:', lang.login);
                } else {
                    console.warn('Login button not found');
                }
                
                const signupBtn = document.querySelector('.signup');
                if (signupBtn) {
                    signupBtn.textContent = lang.signup;
                    console.log('Updated signup button to:', lang.signup);
                } else {
                    console.warn('Signup button not found');
                }
                
                const themeBtn = document.getElementById('themeToggle');
                if (themeBtn) {
                    const isDark = document.body.classList.contains('dark-mode');
                    themeBtn.innerHTML = `<i class="fas fa-${isDark ? 'sun' : 'moon'}"></i> ${isDark ? lang.lightMode : lang.darkMode}`;
                    console.log('Updated theme button');
                } else {
                    console.warn('Theme button not found');
                }
                
                // Update HTML lang attribute
                document.documentElement.lang = language;
                
                // Add success animation
                languageSelect.classList.add('success');
                setTimeout(() => {
                    languageSelect.classList.remove('success');
                }, 2000);
                
                console.log('Language update completed successfully!');
                
                // Show success message
                showMessage(`🌍 Language changed to ${languageSelect.options[languageSelect.selectedIndex].text}`);
            }
            
            // Handle language change
            languageSelect.addEventListener('change', function() {
                console.log('Language changed to:', this.value);
                const selectedLanguage = this.value;
                
                // Add loading state
                this.classList.add('loading');
                
                // Save language preference
                localStorage.setItem('selectedLanguage', selectedLanguage);
                
                // Simulate loading time for better UX
                setTimeout(() => {
                    this.classList.remove('loading');
                    updatePageLanguage(selectedLanguage);
                    
                    // Show success message
                    const successMessage = document.createElement('div');
                    successMessage.className = 'language-change-success';
                    successMessage.textContent = `🌍 Language changed to ${this.options[this.selectedIndex].text}`;
                    successMessage.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: var(--success);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 1000;
                        animation: slideInRight 0.3s ease-out;
                    `;
                    
                    document.body.appendChild(successMessage);
                    
                    setTimeout(() => {
                        successMessage.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => {
                            document.body.removeChild(successMessage);
                        }, 300);
                    }, 3000);
                }, 800);
            });
            
            // Initialize page with saved language
            console.log('Initializing with language:', savedLanguage);
            updatePageLanguage(savedLanguage);
            
            // Add CSS animations for language change notification
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        });

        // Language Selector Functionality - Simple and Direct
        (function() {
            // Wait for DOM to be ready
            function ready(fn) {
                if (document.readyState !== 'loading') {
                    fn();
                } else {
                    document.addEventListener('DOMContentLoaded', fn);
                }
            }
            
            ready(function() {
                console.log('🌍 Language selector initializing...');
                
                // Get language selector
                const languageSelect = document.getElementById('languageSelect');
                
                if (!languageSelect) {
                    console.error('❌ Language selector not found!');
                    return;
                }
                
                console.log('✅ Language selector found!');
                
                // Simple translations
                const translations = {
                    en: {
                        title: 'SmartDoc Converter | File to Database/Excel',
                        convertTitle: 'Convert Files to Database/Excel',
                        convertDesc: 'Upload your Word, Excel, or PowerPoint files to convert them into organized databases or Excel files.',
                        dragDrop: 'Drag & Drop Files Here',
                        clickBrowse: 'or click to browse files (supports multiple files)',
                        convert: 'Convert Files',
                        login: 'Log In',
                        signup: 'Sign Up',
                        darkMode: 'Dark Mode',
                        lightMode: 'Light Mode'
                    },
                    es: {
                        title: 'SmartDoc Converter | Archivo a Base de Datos/Excel',
                        convertTitle: 'Convertir Archivos a Base de Datos/Excel',
                        convertDesc: 'Sube tus archivos de Word, Excel o PowerPoint para convertirlos en bases de datos organizadas o archivos Excel.',
                        dragDrop: 'Arrastra y Suelta Archivos Aquí',
                        clickBrowse: 'o haz clic para explorar archivos (admite múltiples archivos)',
                        convert: 'Convertir Archivos',
                        login: 'Iniciar Sesión',
                        signup: 'Registrarse',
                        darkMode: 'Modo Oscuro',
                        lightMode: 'Modo Claro'
                    },
                    de: {
                        title: 'SmartDoc Converter | Datei zu Datenbank/Excel',
                        convertTitle: 'Dateien zu Datenbank/Excel Konvertieren',
                        convertDesc: 'Laden Sie Ihre Word-, Excel- oder PowerPoint-Dateien hoch, um sie in organisierte Datenbanken oder Excel-Dateien zu konvertieren.',
                        dragDrop: 'Dateien Hier Hineinziehen und Ablegen',
                        clickBrowse: 'oder klicken Sie, um Dateien zu durchsuchen (unterstützt mehrere Dateien)',
                        convert: 'Dateien Konvertieren',
                        login: 'Anmelden',
                        signup: 'Registrieren',
                        darkMode: 'Dunkler Modus',
                        lightMode: 'Heller Modus'
                    },
                    ar: {
                        title: 'سمارت دوك كونفرتر | تحويل الملفات إلى قاعدة بيانات/إكسل',
                        convertTitle: 'تحويل الملفات إلى قاعدة بيانات/إكسل',
                        convertDesc: 'قم بتحميل ملفات وورد أو إكسل أو بوربوينت لتحويلها إلى قواعد بيانات منظمة أو ملفات إكسل.',
                        dragDrop: 'اسحب وأفلت الملفات هنا',
                        clickBrowse: 'أو انقر لتصفح الملفات (يدعم ملفات متعددة)',
                        convert: 'تحويل الملفات',
                        login: 'تسجيل الدخول',
                        signup: 'إنشاء حساب',
                        darkMode: 'الوضع الداكن',
                        lightMode: 'الوضع الفاتح'
                    }
                };
                
                // Function to update page content
                function updateLanguage(langCode) {
                    console.log('Updating to language:', langCode);
                    const lang = translations[langCode] || translations.en;
                    
                    try {
                        // Update title
                        document.title = lang.title;
                        
                        // Update main content
                        const titleEl = document.querySelector('.upload-section h2');
                        if (titleEl) titleEl.textContent = lang.convertTitle;
                        
                        const descEl = document.querySelector('.upload-section p');
                        if (descEl) descEl.textContent = lang.convertDesc;
                        
                        const dragEl = document.querySelector('.upload-area h3');
                        if (dragEl) dragEl.textContent = lang.dragDrop;
                        
                        const browseEl = document.querySelector('.upload-area p');
                        if (browseEl) browseEl.textContent = lang.clickBrowse;
                        
                        // Update buttons
                        const convertBtn = document.querySelector('.convert-btn');
                        if (convertBtn) convertBtn.textContent = lang.convert;
                        
                        const loginBtn = document.querySelector('.login');
                        if (loginBtn) loginBtn.textContent = lang.login;
                        
                        const signupBtn = document.querySelector('.signup');
                        if (signupBtn) signupBtn.textContent = lang.signup;
                        
                        // Update theme button
                        const themeBtn = document.getElementById('themeToggle');
                        if (themeBtn) {
                            const isDark = document.body.classList.contains('dark-mode');
                            themeBtn.innerHTML = `<i class="fas fa-${isDark ? 'sun' : 'moon'}"></i> ${isDark ? lang.lightMode : lang.darkMode}`;
                        }
                        
                        // Update HTML lang attribute
                        document.documentElement.lang = langCode;
                        
                        console.log('Language update completed successfully!');
                        
                        // Show success message
                        showMessage(`🌍 Language changed to ${languageSelect.options[languageSelect.selectedIndex].text}`);
                        
                    } catch (error) {
                        console.error('❌ Error updating language:', error);
                        showMessage('❌ Error updating language. Please try again.');
                    }
                }
                
                // Function to show message
                function showMessage(text) {
                    const msg = document.createElement('div');
                    msg.textContent = text;
                    msg.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4cc9f0;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-weight: bold;
                        animation: slideInRight 0.3s ease-out;
                    `;
                    document.body.appendChild(msg);
                    
                    setTimeout(() => {
                        msg.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => {
                            if (msg.parentNode) msg.remove();
                        }, 300);
                    }, 3000);
                }
                
                // Load saved language
                const savedLang = localStorage.getItem('selectedLanguage') || 'en';
                languageSelect.value = savedLang;
                console.log('📝 Loaded saved language:', savedLang);
                
                // Initialize with saved language
                updateLanguage(savedLang);
                
                // Add change event listener
                languageSelect.addEventListener('change', function() {
                    const newLang = this.value;
                    console.log('🔄 Language changed to:', newLang);
                    
                    // Save preference
                    localStorage.setItem('selectedLanguage', newLang);
                    
                    // Update language
                    updateLanguage(newLang);
                });
                
                console.log('🎉 Language selector initialized successfully!');
            });
        })();
    </script>
</body>
</html>
